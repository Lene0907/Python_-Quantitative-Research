#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun May 28 20:03:31 2023

@author: gulining
"""
import pandas as pd
import numpy as np
import datetime as dt
from datetime import timedelta
import matplotlib.pyplot as plt
from matplotlib.dates import DateFormatter # è®¾å®šx/yè½´datetimeæ˜¾ç¤ºæ ¼å¼
import matplotlib.ticker as ticker # ä¿®æ”¹xè½´æ ‡ç­¾è¿‡äºå¯†é›†çš„é—®é¢˜
import scipy.optimize as sco # æœ€ä¼˜åŒ–
from scipy import stats
plt.rcParams['font.sans-serif'] = ['SimHei']  #è®¾ç½®ä¸­æ–‡é»‘ä½“æ˜¾ç¤º
plt.rcParams['axes.unicode_minus'] = False    #è®¾ç½®ç¬¦å·æ­£ç¡®æ˜¾ç¤º
import os
import math
#%%
"""å®šä¹‰æ¨¡å—"""
class Performance:
    def __init__(self,sr_netvalue:np.ndarray,sr_pred=False):
        """
        è¾“å…¥ï¼šèµ„äº§/å‡€å€¼ Series
        è¾“å‡ºï¼šè¡¨ç°
        """
        self.sr_netvalue = sr_netvalue
        """æ”¶ç›Šç‡"""
        self.annualized_returns = round((self.sr_netvalue/self.sr_netvalue.shift(1)-1).mean()*242,5)
        """æ³¢åŠ¨ç‡æ°´å¹³"""
        self.annualized_volatility = round((self.sr_netvalue/self.sr_netvalue.shift(1)-1).std()*np.sqrt(242),4)
        """æœ€å¤§å›æ’¤"""
        self.mdd = 0
        peak = self.sr_netvalue[0]
        for x in np.array(self.sr_netvalue):
            if x > peak:
                peak = x    
            dd = (peak - x) / peak
            if dd > self.mdd:
                self.mdd = dd      
    def cal_sharp(self):
        """å¹´åŒ–å¤æ™®æ¯”ç‡"""
        return round((self.annualized_returns-0.02)/ self.annualized_volatility,4)
    def max_drawdown(self):
        """æœ€å¤§å›æ’¤"""
        return round(self.mdd,4) 
    def cal_calmar(self):
        """å¹´åŒ–å¡ç›æ¯”ç‡"""
        return round((self.annualized_returns-0.02)/self.mdd,4)
    def accumulate_net_value(self):
        """ç´¯è®¡å‡€å€¼"""
        return round(self.sr_netvalue[-1],4)

def risk_budgeting(cov,b=np.array([0.98,0.02])):
    """æ„å»ºé£é™©é¢„ç®—æ¨¡å‹
    inputï¼šåæ–¹å·®cov
    outputï¼šå„èµ„äº§æƒé‡w
    """
    def f(w):
        w = np.array(w)
        std = np.sqrt(np.dot(w.T,np.dot(cov,w))) # ç»„åˆé£é™©
        MRC = np.dot(cov, w) / std # èµ„äº§å¯¹æ•´ä¸ªèµ„äº§ç»„åˆçš„è¾¹é™…é£é™©è´¡çŒ®
        TRC = w * MRC # èµ„äº§å¯¹æ•´ä¸ªç»„åˆçš„é£é™©è´¡çŒ®
        delta_TRC = 0
        for i in range(len(b)):
            for j in range(len(b)):
                delta_TRC += (TRC[i]/b[i] - TRC[j]/b[j])**2
        return delta_TRC
    x0 = np.ones(cov.shape[0])/cov.shape[0]
    cons = ({'type':'eq','fun':lambda w:np.sum(w)-1})
    bnds = tuple((0,1) for x in x0)
    options={'disp':False, 'maxiter':1000, 'ftol':1e-20}
    result = sco.minimize(f, x0, method="SLSQP", 
                          bounds=bnds, constraints=cons,options=options)
    return result.x

def get_last_day(start_year,end_year):
    """è·å–æ—¶é—´èŒƒå›´å†…æ¯ä¸ªæœˆçš„æœ€åä¸€å¤©å¹¶æ ¼å¼åŒ–æˆ'yyyy-mm-dd'çš„datetimeæ ¼å¼
    inputï¼šstart_year,end_yearï¼Œæ ¼å¼å¦‚â€˜2022â€™ï¼Œå‰é—­åå¼€ï¼Œä¸åŒ…æ‹¬end_yearå½“å¹´
    outputï¼šdatetimeæ ¼å¼çš„æ¯ä¸ªæœˆæœ€åä¸€å¤©
    """
    import calendar
    daliy = []
    for years in range(start_year,end_year):
        for month in range(1,13):
            cal = calendar.month(years,month)
            day = int(cal[-3:])
            daliy.append((years,month,day))
    date = []
    for i in daliy:
        y = str(i[0])
        if i[1] < 10:
            m = str('0'+str(i[1]))
        else:
            m = str(i[1])
        if i[2] < 10:
            d = str('0'+str(i[2]))
        else:
            d = str(i[2])
        date.append(pd.to_datetime(y+'-'+m+'-'+d,format='%Y-%m-%d'))
    return date

class Statistic_data():
    """è¡¨ç°æŒ‡æ ‡
    position:ä¿¡å·å‘¨æœŸresize_list
    signal:å»ºä»“å‘¨æœŸ
    position_change:æŒä»“æ¶¨è·Œå¹…
        """
    def __init__(self,position:np.ndarray,signal:np.ndarray,position_change):
        self.position = position
        self.signal = signal
        self.position_change = position_change.dropna()
        self.position_change_df = pd.DataFrame(self.position_change)
        self.position_change_df['yyyymm'] = self.position_change_df.index.strftime('%Y-%m')
        self.r_temp = self.position_change_df.groupby('yyyymm').apply(lambda x: (1+x).cumprod())
        self.r_temp['yyyymm'] = self.r_temp.index.strftime('%Y-%m')
        self.r_temp_ = self.r_temp.groupby('yyyymm').last()
        self.sr_netvalue = self.r_temp
    def sum_period(self):
        return len(self.position) # åˆè®¡å‘¨æœŸ
    
    def sum_signal(self):
        return len(self.signal[(self.signal ==1)|(self.signal ==-1)]) # ä¿¡å·æ¬¡æ•°
    def sum_long_signal(self):
        return len(self.signal[self.signal == 1]) # å¤šå¤´
    def sum_short_signal(self):
        return len(self.signal[self.signal == -1]) # ç©ºå¤´
    def win_rate(self):
        # èƒœç‡
        return round(len(self.r_temp_[self.r_temp_ > 1].dropna()) / len(self.r_temp_.dropna()),2) 
        # return round(len(self.position_change[self.position_change > 0])/len(self.position_change), 2) # èƒœç‡
    def profi_loss_ratio(self):
        # ç›ˆäºæ¯”
        # æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
        """ç›ˆäºæ¯”"""
        # p   = self.position_change[self.position_change>0].sum()/(self.position_change>0).sum() # æ­£æ”¶ç›Šæ¯æ—¥å¹³å‡å€¼
        # c   = abs(self.position_change[self.position_change<0].sum()/(self.position_change<0).sum()) # è´Ÿæ”¶ç›Šæ¯æ—¥å¹³å‡å€¼
        # ratio = p/c
        # return ratio
        return round(len(self.r_temp_[self.r_temp_ > 1].dropna()) / len(self.r_temp_[self.r_temp_ < 1].dropna()),2) 
        # äº¤æ˜“è·åˆ©æ¬¡æ•°å æ€»æ¬¡æ•°çš„ç™¾åˆ†æ¯”
    def expectation(self):
        # æœŸæœ›=å¹³å‡ç›ˆåˆ©Ã—èƒœç‡ï¼å¹³å‡äºæŸÃ—ï¼ˆ1ï¼èƒœç‡ï¼‰
        # æœŸæœ› = ç›ˆäºæ¯”*èƒœç‡- 1*ï¼ˆ1-èƒœç‡ï¼‰
        return round(self.profi_loss_ratio() * self.win_rate() -(1-self.win_rate()),2)#position_change > 0])/len(self.position_change[self.position_change < 0]), 2)  # æœŸæœ›   
def drawdown(cum_returns):
    """ input:ç´¯è®¡æ”¶ç›Šç‡/å‡€å€¼åºåˆ—
        output:å›æ’¤åºåˆ—
    """
    # è®¡ç®—å†å²å³°å€¼
    historical_peak = cum_returns.cummax()
    # è®¡ç®—æ¯å¤©çš„å›æ’¤
    drawdown = (cum_returns - historical_peak) / historical_peak
    return drawdown    
def signal_count_net_value_au(daily_return_df,N,name,name_basis='TIPSæ”¶ç›Šç‡',name_target='ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'):
    """
    -------è®¡ç®—ç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ
    input:
        daily_return_df:åŒ…æ‹¬å›æµ‹æŒ‡æ ‡å’Œæ ‡çš„æ”¶ç›Š
        N = Næ—¥å‡çº¿
        name = 'å¤šç©º' â€”â€”æŒ‡æ ‡å‘½å
        name = 'å¤šç©º'/â€˜çº¯å¤šå¤´'/'çº¯ç©ºå¤´'
        name_basis = 'TIPSæ”¶ç›Šç‡'â€”â€”å›æµ‹æŒ‡æ ‡
        name_target = 'ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'â€”â€”æ ‡çš„æ”¶ç›Š
    output:
        resize_list_auâ€”â€”â€”â€”åˆè®¡å‘¨æœŸâ€”â€”series
        daily_return[[name+'å»ºä»“te',name+'æŒä»“æ¶¨è·Œå¹…',name+'æŒä»“å‡€å€¼']]â€”â€”â€”â€”ä¿¡å·æ¬¡æ•°ã€æŒä»“æ¶¨è·Œå¹…ã€æŒä»“å‡€å€¼â€”â€”df
    """
    daily_return = daily_return_df.dropna().copy()
    if N == 1:
        # æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
        daily_return['date'] = daily_return.index
        daily_return['yyyymm'] = daily_return.index.strftime('%Y-%m')
        resize_list_au = daily_return.groupby(daily_return['yyyymm']).last()['date']
        if name =='çº¯å¤šå¤´':
            daily_return[name+'æŒä»“æ¶¨è·Œå¹…'] = daily_return[name_target]
            for i in resize_list_au:
                daily_return.loc[i,name+'å»ºä»“te'] = 1
        elif name =='çº¯ç©ºå¤´':
            daily_return[name+'æŒä»“æ¶¨è·Œå¹…'] = - daily_return[name_target]
            for i in resize_list_au:
                daily_return.loc[i,name+'å»ºä»“te'] = -1
        else:
            print('errorï¼')
        daily_return[name+'æŒä»“å‡€å€¼'] = (1+ daily_return[name+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
        daily_return[name+'æŒä»“å‡€å€¼'] = daily_return[name+'æŒä»“å‡€å€¼'].fillna(method='ffill')
    else:
        daily_return[name_basis+'_N='+str(N)] = daily_return[name_basis].rolling(window=N).mean()
        # æ„å»ºä¿¡å·
        condition1 = daily_return[name_basis] > daily_return[name_basis+'_N='+ str(N)]
        condition2 = daily_return[name_basis] < daily_return[name_basis+'_N='+ str(N)]
        daily_return.loc[condition1,name+'signal'] = -1
        daily_return.loc[condition2,name+'signal'] = 1
        # æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
        daily_return['date'] = daily_return.index
        daily_return['yyyymm'] = daily_return.index.strftime('%Y-%m')
        resize_list_au = daily_return.groupby(daily_return['yyyymm']).last()['date']
        for i in resize_list_au:
            if name == 'å¤šç©º':
                if daily_return.loc[i,name+'signal'] == 1:
                    daily_return.loc[i,name+'å»ºä»“te'] = 1
                elif daily_return.loc[i,name+'signal'] == -1:
                    daily_return.loc[i,name+'å»ºä»“te'] = -1
                else:
                    daily_return.loc[i,name+'å»ºä»“te'] = 0
            elif name == 'çº¯å¤šå¤´':
                if daily_return.loc[i,name+'signal'] == 1:
                    daily_return.loc[i,name+'å»ºä»“te'] = 1
                else:
                    daily_return.loc[i,name+'å»ºä»“te'] = 0
            elif name == 'çº¯ç©ºå¤´':
                if daily_return.loc[i,name+'signal'] == -1:
                    daily_return.loc[i,name+'å»ºä»“te'] = -1
                else:
                    daily_return.loc[i,name+'å»ºä»“te'] = 0
            else:
                print('å‚æ•°nameè®¾ç½®é”™è¯¯ï¼Œè¯·è°ƒæ•´ã€‚')
        daily_return[name+'å»ºä»“'] = daily_return[name+'å»ºä»“te'].shift(1)
        daily_return[name+'å»ºä»“'] = daily_return[name+'å»ºä»“'].fillna(method='ffill')
        condition1 = daily_return[name+'å»ºä»“'] == 1
        condition2 = daily_return[name+'å»ºä»“'] == -1
        daily_return.loc[condition1,name+'æŒä»“'] = 1
        daily_return.loc[condition2,name+'æŒä»“'] = -1
        daily_return[name+'æŒä»“æ¶¨è·Œå¹…'] = daily_return[name+'æŒä»“'] * daily_return[name_target]
        daily_return[name+'æŒä»“å‡€å€¼'] = 1 + daily_return[name+'æŒä»“æ¶¨è·Œå¹…']
        daily_return[name+'æŒä»“å‡€å€¼'] = daily_return[name+'æŒä»“å‡€å€¼'].cumprod()
        daily_return[name+'æŒä»“å‡€å€¼'] = daily_return[name+'æŒä»“å‡€å€¼'].fillna(method='ffill')
    return resize_list_au,daily_return[[name+'å»ºä»“te',name+'æŒä»“æ¶¨è·Œå¹…',name+'æŒä»“å‡€å€¼']]
#%%
# æ–‡ä»¶è·¯å¾„â€”â€”â€”â€”éœ€è¦ä¿®æ”¹æˆç›¸åº”çš„æ–‡ä»¶è·¯å¾„
os.chdir('/Users/gulining/Downloads/ç ”ç©¶ç”Ÿ-/è¯¾ç¨‹èµ„æ–™/ç ”ä¸€ä¸‹/ï¼ˆç ”ï¼‰Pythonä¸é‡‘èæ•°æ®åˆ†æï¼ˆ22-23-2ï¼‰/æœŸæœ«è€ƒæ ¸/')
# åˆ›å»ºæ–‡ä»¶å¤¹_å­˜å‚¨è¾“å‡ºçš„å›¾ç‰‡ã€è¡¨æ ¼
try:
    os.mkdir('./output')
except:
    pass
#%%
"""ç”±äºç ”æŠ¥æ²¡æœ‰è¯´æ˜å…·ä½“çš„æ•°æ®è®¾å®šï¼Œå¦‚åå¤æƒ/å‰å¤æƒ/ä¸å¤æƒï¼›å†å¦‚æ™®é€šæŒ‡æ•°/å…¨æ”¶ç›ŠæŒ‡æ•°ï¼›ä¹Ÿæ²¡æœ‰æŒ‡å‡ºå…·ä½“çš„è°ƒä»“è§„åˆ™/åŠ å‡ä»“è§„åˆ™ï¼Œç›¸åº”éƒ¨åˆ†æ˜¯æŒ‰ç¬”è€…ä¸ªäººç†è§£è¿›è¡Œè®¾è®¡ï¼Œå’Œç ”æŠ¥ä¸­çš„ç»“æœå¯èƒ½ä¼šæœ‰å‡ºå…¥"""
# å¯¼å…¥æ•°æ® 
# ä¸­è¯800æŒ‡æ•°(sh000906) å…¨æ”¶ç›ŠæŒ‡æ•°
# index_800 = pd.read_excel(r'./æ•°æ®/800æ”¶ç›Šåå¤æƒ.xlsx',sheet_name='Sheet1',index_col=0,header=3)
index_800 = pd.read_excel(r'./æ•°æ®/800æ”¶ç›Šä¸å¤æƒ.xlsx',sheet_name='ä¸å¤æƒ',index_col=0,header=3)
index_800.index = pd.to_datetime(index_800.index)
# ä¸­å€ºç»¼åˆæŒ‡æ•°M0051552
index_bond = pd.read_excel(r'./æ•°æ®/ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°.xlsx',sheet_name='Sheet1',index_col=0,header=3)#,encoding='gbk'
index_bond.index = pd.to_datetime(index_bond.index)
index_bond.rename(columns={'CBA00201.CS':'bond'},inplace=True)
# ä¸Šæµ·é‡‘äº¤æ‰€é»„é‡‘ç°è´§_æ”¶ç›˜ä»·_Au9999
# au9999 = pd.read_csv(r'./æ•°æ®/ä¸Šæµ·é‡‘äº¤æ‰€é»„é‡‘ç°è´§_æ”¶ç›˜ä»·_Au9999.csv')#,encoding='gbk'
au9999 = pd.read_excel(r'./æ•°æ®/AU9999.SGE.xlsx',sheet_name='Sheet1',index_col=0,header=3)
au9999.index = pd.to_datetime(au9999.index)
au9999.rename(columns={'close':'Au'},inplace=True)
au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'] = au9999['Au'].pct_change()
au9999['ä¸Šæµ·é»„é‡‘ç°è´§'] = au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'] + 1
au9999['ä¸Šæµ·é»„é‡‘ç°è´§'].iloc[0] = 1
au9999['ä¸Šæµ·é»„é‡‘ç°è´§'] = au9999['ä¸Šæµ·é»„é‡‘ç°è´§'].cumprod()
#%%
"""
1å¼•è¨€ 6 
2èµ„äº§çš„é€‰æ‹©
2.1 å…¨çƒèµ„äº§çš„ç›¸å…³æ€§.
2.2 è‚¡å€ºé‡‘ä¸šç»©è¡¨ç°..... 8 
    å›¾3ï¼šä¸‰ç±»èµ„äº§çš„å†å²å‡€å€¼æ›²çº¿ï¼ˆ2005.1.4-2023.8.30ï¼‰
    è¡¨2ï¼šä¸‰ç±»èµ„äº§å†å²è¡¨ç°ï¼ˆ2005.1.4-2023.8.30ï¼‰
    è¡¨3ï¼šå„ç±»èµ„äº§å†å¹´é£é™©æ”¶ç›Šæƒ…å†µï¼ˆ2005.1.4-2023.8.30ï¼‰
"""
# å›¾3ï¼šä¸‰ç±»èµ„äº§çš„å†å²å‡€å€¼æ›²çº¿
net_value_800 = index_800['close']
net_value_800 = pd.DataFrame(net_value_800)
# ä¸­è¯800
net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] = net_value_800['close'].pct_change()
net_value_800['ä¸­è¯800'] = net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] + 1
net_value_800['ä¸­è¯800'].iloc[0] = 1
net_value_800['ä¸­è¯800'] = net_value_800['ä¸­è¯800'].cumprod()
# ä¸­å€ºç»¼åˆæŒ‡æ•°M0051552
net_value_bond = index_bond
net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'] = net_value_bond['bond'].pct_change()
net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] = net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'] + 1
net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'].iloc[0] = 1
net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] = net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'].cumprod()
# ä¸Šæµ·é‡‘äº¤æ‰€é»„é‡‘ç°è´§_æ”¶ç›˜ä»·_Au9999
net_value_au9999 = au9999.loc['2005-01-04':,:]
# net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'] = net_value_au9999['Au'].pct_change()
# net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§'] = net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'] + 1
# net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§'].iloc[0] = 1
# net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§'] = net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§'].cumprod()
# ç­‰æƒé‡
equal_net_value = pd.DataFrame()
equal_net_value = pd.concat([net_value_800,net_value_bond,net_value_au9999],axis=1)
equal_net_value['ç­‰æƒé‡'] = ( equal_net_value['ä¸­è¯800'] + equal_net_value['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] + equal_net_value['ä¸Šæµ·é»„é‡‘ç°è´§'] ) / 3
equal_net_value['ç­‰æƒé‡æ¯æ—¥æ¶¨è·Œå¹…'] = equal_net_value['ç­‰æƒé‡']/equal_net_value['ç­‰æƒé‡'].shift(1) - 1
equal_net_value['ç­‰æƒé‡æ¯æ—¥æ¶¨è·Œå¹…'][0] = (net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'][0] + 
                                net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'][0] + 
                                net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'][0]) / 3
equal_net_value = equal_net_value.loc['2005-01-04':,:]
#%%
# ç»˜åˆ¶å›¾3ï¼šä¸‰ç±»èµ„äº§çš„å†å²å‡€å€¼æ›²çº¿
fig,ax =plt.subplots(figsize=(10,6))
ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
plt.plot(equal_net_value['ä¸Šæµ·é»„é‡‘ç°è´§'],c=[0.1,0.2,0.8],label=u'ä¸Šæµ·é»„é‡‘ç°è´§',lw=2.5)
plt.plot(equal_net_value['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'],c=[0.0,0.8,1.0],label=u'ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°',lw=2.5)
plt.plot(equal_net_value['ä¸­è¯800'],c=[1.0,0.8,0.0],label=u'ä¸­è¯800',lw=2.5)
plt.plot(equal_net_value['ç­‰æƒé‡'],'r',label=u'ç­‰æƒé‡',lw=2.5)
x = DateFormatter('%Y-%m-%d') # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.gca().xaxis.set_major_formatter(x)
plt.xticks(fontsize=13,rotation=30)
plt.xlim([equal_net_value.index[0],equal_net_value.index[-1]]) # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.xticks([dt.datetime(2005+j,1,4) for j in range(19)])
plt.yticks(fontsize=13)
plt.ylim([0,7])
plt.title('å›¾3ï¼šä¸‰ç±»èµ„äº§çš„å†å²å‡€å€¼æ›²çº¿',fontsize=13)
plt.legend(loc=0,fontsize=10)
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾3ï¼šä¸‰ç±»èµ„äº§çš„å†å²å‡€å€¼æ›²çº¿.png',dpi=800)
#%%
# è¡¨2ï¼šä¸‰ç±»èµ„äº§å†å²è¡¨ç°
t2_info = equal_net_value.copy()
t2 = pd.DataFrame()
name_list = ['ä¸Šæµ·é»„é‡‘ç°è´§','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°','ä¸­è¯800','ç­‰æƒé‡']
for j in name_list:
    t2.loc[j,'å¹´åŒ–æ”¶ç›Šç‡'] = Performance(t2_info[j]).annualized_returns
    t2.loc[j,'æ³¢åŠ¨ç‡'] = Performance(t2_info[j]).annualized_volatility
    t2.loc[j,'å¤æ™®'] = Performance(t2_info[j]).cal_sharp()
    t2.loc[j,'æœ€å¤§å›æ’¤'] = Performance(t2_info[j]).max_drawdown()
    t2.loc[j,'å¡ç›æ¯”ç‡'] = Performance(t2_info[j]).cal_calmar()
t2.to_excel(r'./output/è¡¨2ï¼šä¸‰ç±»èµ„äº§å†å²è¡¨ç°.xlsx')
#%%
# è¡¨3ï¼šå„ç±»èµ„äº§å†å¹´é£é™©æ”¶ç›Šæƒ…å†µ
t3_info = equal_net_value.copy()
t3_info['date'] = t3_info.index.strftime('%Y')
N = t3_info.index[-1].year - t3_info.index[0].year + 1
start_year = '2005' # è®¾ç½®èµ·å§‹æ—¶é—´
t3 = pd.DataFrame()
name_list = ['ä¸­è¯800','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°','ä¸Šæµ·é»„é‡‘ç°è´§','ç­‰æƒé‡']
# è®¡ç®—å„èµ„äº§å’Œç­‰æƒé‡ç»„åˆå„å¹´åº¦æœ€å¤§å›æ’¤
for i in range(N):
    for j in name_list:
        net = (1+t3_info.loc[t3_info['date'] == start_year,j+'æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
        t3.loc[start_year,j+'_æ”¶ç›Šç‡'] = Performance(net).annualized_returns
        t3.loc[start_year,j+'_æ³¢åŠ¨ç‡'] = Performance(net).annualized_volatility
        t3.loc[start_year,j+'_æœ€å¤§å›æ’¤'] = Performance(net).max_drawdown()
    start_year = str(int(start_year) + 1)
t3.to_excel(r'./output/è¡¨3ï¼šå„ç±»èµ„äº§å†å¹´é£é™©æ”¶ç›Šæƒ…å†µ.xlsx')
#%%
"""
3. æˆ˜ç•¥:é£é™©é¢„ç®—æ¨¡å‹å®è·µ.. 10 
3.1 é£é™©é¢„ç®—æ¨¡å‹ä»‹ç»....
3.2é£é™©é¢„ç®—æ¨¡å‹å®è·µ 11 
    å›¾4ï¼šé£é™©é¢„ç®— vs å›ºå®šè‚¡å€ºæ¯”å‡€å€¼ï¼ˆ2013.1.1-2023.8.30ï¼‰
    è¡¨6ï¼šé£é™©é¢„ç®—å’Œå›ºå®šæ¯”ä¾‹ä¸šç»©è¡¨ç°ï¼ˆ2013.1.1-2023.8.30ï¼‰
    å›¾5ï¼šé£é™©é¢„ç®—vså›ºå®šè‚¡å€ºæ¯”ä»“ä½ï¼ˆ2013.1.1-2023.8.30ï¼‰
"""
# é€‰å®šæ‰€éœ€æ•°æ®
rets = equal_net_value[['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']]
# å›æµ‹æœˆæ•°m_s
m_s = get_last_day(2012,2024) # è·å–æ—¶é—´èŒƒå›´å†…æ¯ä¸ªæœˆçš„æœ€åä¸€å¤©å¹¶æ ¼å¼åŒ–æˆ'yyyy-mm-dd'çš„datetimeæ ¼å¼
m_s = m_s[11:-4] # å»æ‰å›æµ‹æœŸä»¥å¤–çš„æ—¶é—´èŒƒå›´ã€‚
p5_w = pd.DataFrame() # p5_wå­˜å‚¨é£é™©é¢„ç®—åˆ†é…è‚¡å€ºæƒé‡
for i in m_s:
    i_rets = rets.loc[:i,:][-60:]
    cov = np.array(i_rets.cov())
    w = risk_budgeting(cov)
    if w[0] > 0.3:
        w[0] = 0.3 # é™åˆ¶é£é™©èµ„äº§ï¼ˆè‚¡ç¥¨ï¼‰ä»“ä½<=30%
        w[1] = 0.7
    p5_w.loc[i+timedelta(days=1),'ä¸­è¯800'] = w[0]
    p5_w.loc[i+timedelta(days=1),'ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] = w[1]
# å¯è§†åŒ–â€”â€”â€”â€”å›¾5:é£é™©é¢„ç®—vså›ºå®šè‚¡å€ºæ¯”ä»“ä½
fig,ax = plt.subplots(figsize=(8,5))
ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
plt.stackplot(p5_w.index, p5_w.iloc[:,0],p5_w.iloc[:,1],
              labels=(u'ä¸­è¯800',u'ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'),
              colors = ['#003D79','#FFD306'] )
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.gca().yaxis.set_major_formatter(ticker.PercentFormatter(1)) #çºµè½´è®¾ç½®ä¸ºç™¾åˆ†æ¯”
plt.xticks(fontsize=10,rotation=30)
plt.xlim([p5_w.index[0],p5_w.index[-1]]) # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.xticks([dt.datetime(2013+j,1,1) for j in range(11)])
plt.ylim([0,1])
plt.yticks([0,0.2,0.4,0.6,0.8,1],fontsize=10)
plt.legend(loc=0,fontsize=13)
plt.title(u'å›¾5:é£é™©é¢„ç®—vså›ºå®šè‚¡å€ºæ¯”ä»“ä½')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾5ï¼šé£é™©é¢„ç®—vså›ºå®šè‚¡å€ºæ¯”ä»“ä½.png',dpi=800)
#%%
# å›¾4ï¼šé£é™©é¢„ç®— vs å›ºå®šè‚¡å€ºæ¯”å‡€å€¼
p4 = (p5_w.loc[:'2023-08-30',:]).copy()
p4.rename(columns={'ä¸­è¯800':'é£é™©é¢„ç®—_ä¸­è¯800','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°':'é£é™©é¢„ç®—_ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'},inplace=True)
# å›ºå®šæ¯”ä¾‹è‚¡å€ºæ•°æ®è®¾å®š
p4.loc[:,'å›ºå®šæ¯”ä¾‹_ä¸­è¯800'] = 0.2
p4.loc[:,'å›ºå®šæ¯”ä¾‹_ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] = 0.8
p4 = pd.concat([p4,equal_net_value[['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']]],axis=1) # æ‹¼æ¥æ•°æ®ï¼šè‚¡å€ºæƒé‡ä¸æ¯æ—¥æ¶¨è·Œå¹…
p4 = p4.loc['2013-01-01':,:] # åªå–æ‰€éœ€æ—¶é—´æ®µ
# é€šè¿‡fillnaåˆ¤æ–­æ¯æœˆæœ€åä¸€å¤©æ˜¯å¦æ˜¯äº¤æ˜“æ—¥ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å½“å¤©æ¶¨è·Œå¹…èµ‹å€¼ä¸º0
p4['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'].fillna(value=0,inplace=True)
p4['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'].fillna(value=0,inplace=True)
# å¡«å……æƒé‡ç¼ºå¤±å€¼
p4.fillna(method='ffill',inplace=True) 
# å›ºå®šæ¯”ä¾‹è‚¡å€º20/80å‡€å€¼
p4['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80_æ¯æ—¥æ¶¨è·Œå¹…'] = p4['å›ºå®šæ¯”ä¾‹_ä¸­è¯800'] * p4['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] + p4['å›ºå®šæ¯”ä¾‹_ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] * p4['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']
p4['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80']  = (1+p4['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80_æ¯æ—¥æ¶¨è·Œå¹…'] ).cumprod()
# é£é™©é¢„ç®—è‚¡å€º98/2å‡€å€¼
p4['é£é™©é¢„ç®—è‚¡å€º98/2_æ¯æ—¥æ¶¨è·Œå¹…'] = p4['é£é™©é¢„ç®—_ä¸­è¯800'] * p4['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] + p4['é£é™©é¢„ç®—_ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°'] * p4['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']
p4['é£é™©é¢„ç®—è‚¡å€º98/2'] = (1+p4['é£é™©é¢„ç®—è‚¡å€º98/2_æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
# è¶…é¢
p4['è¶…é¢'] = p4['é£é™©é¢„ç®—è‚¡å€º98/2'] - p4['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80']
# ç»˜å›¾å¯è§†åŒ–â€”â€”â€”â€”å›¾4:é£é™©é¢„ç®— vs å›ºå®šè‚¡å€ºæ¯”å‡€å€¼
fig, ax1 = plt.subplots(figsize=(8,4))
ax1.spines['top'].set_visible(False)
l1 = ax1.fill_between(p4.index,p4['è¶…é¢'],label='è¶…é¢',color ='#FFD306' ,interpolate=True)
plt.xticks(fontsize=10,rotation=30)
plt.yticks(fontsize=10)
plt.ylim([-0.05,0.3])
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = ax2.plot(p4['é£é™©é¢„ç®—è‚¡å€º98/2'], lw=2.5,label='é£é™©é¢„ç®—è‚¡å€º98/2ï¼ˆå³ï¼‰',color='royalblue')#'cornflowerblue'
l3, = ax2.plot(p4['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80'], lw=2.5,label='å›ºå®šæ¯”ä¾‹è‚¡å€º20/80ï¼ˆå³ï¼‰',color='#003D79')
plt.xlim([p4.index[0],p4.index[-2]])  # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.ylim([0.8,2])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
# å›¾ä¾‹åˆå¹¶
g = [l1, l2 ,l3]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.title(u'å›¾4:é£é™©é¢„ç®— vs å›ºå®šè‚¡å€ºæ¯”å‡€å€¼')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾4ï¼šé£é™©é¢„ç®— vs å›ºå®šè‚¡å€ºæ¯”å‡€å€¼.png',dpi=800)
#%%
# è¡¨6ï¼šé£é™©é¢„ç®—å’Œå›ºå®šæ¯”ä¾‹ä¸šç»©è¡¨ç°
t6_net = p4[['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80','é£é™©é¢„ç®—è‚¡å€º98/2']]
t6_net['year'] = t6_net.index.year
y_s = t6_net.index[-1].year - t6_net.index[0].year + 1
t6 = pd.DataFrame()
start_year = 2013
name_list = ['å›ºå®šæ¯”ä¾‹è‚¡å€º20/80','é£é™©é¢„ç®—è‚¡å€º98/2']
perform_list = ['æ”¶ç›Šç‡','æ³¢åŠ¨ç‡','å¤æ™®','æœ€å¤§å›æ’¤','å¡ç›æ¯”ç‡']
for i in range(y_s):
    temp_1 = t6_net[ t6_net['year'] ==  start_year]
    for j in name_list:
        t6.loc[start_year,'æ”¶ç›Šç‡_'+j] = Performance(temp_1[j]).annualized_returns
        t6.loc[start_year,'æ³¢åŠ¨ç‡_'+j] = Performance(temp_1[j]).annualized_volatility
        t6.loc[start_year,'å¤æ™®_'+j] = Performance(temp_1[j]).cal_sharp()
        t6.loc[start_year,'æœ€å¤§å›æ’¤_'+j] = Performance(temp_1[j]).max_drawdown()
        t6.loc[start_year,'å¡ç›æ¯”ç‡_'+j] = Performance(temp_1[j]).cal_calmar()
    start_year += 1
for j in name_list:
    t6.loc['åŒºé—´','æ”¶ç›Šç‡_'+j] = Performance(p4[j]).annualized_returns
    t6.loc['åŒºé—´','æ³¢åŠ¨ç‡_'+j] = Performance(p4[j]).annualized_volatility
    t6.loc['åŒºé—´','å¤æ™®_'+j] = Performance(p4[j]).cal_sharp()
    t6.loc['åŒºé—´','æœ€å¤§å›æ’¤_'+j] = Performance(p4[j]).max_drawdown()
    t6.loc['åŒºé—´','å¡ç›æ¯”ç‡_'+j] = Performance(p4[j]).cal_calmar()
t6['ç›¸å¯¹å¤æ™®'] = t6['å¤æ™®_é£é™©é¢„ç®—è‚¡å€º98/2']-t6['å¤æ™®_å›ºå®šæ¯”ä¾‹è‚¡å€º20/80']
t6.to_excel(r'./output/è¡¨6ï¼šé£é™©é¢„ç®—å’Œå›ºå®šæ¯”ä¾‹ä¸šç»©è¡¨ç°.xlsx')
#%%
"""
4. æˆ˜æœ¯:è‚¡å€ºæ‹©æ—¶æ¨¡å‹ã€é»„é‡‘æ‹©æ—¶æ¨¡å‹.. 12 
4.1 è‚¡å€ºæ‹©æ—¶æ¨¡å‹.... 13 
4.1.1 ERP è‚¡å€ºæ€§ä»·æ¯”æŒ‡æ ‡... 13 
    å›¾7ï¼šERPä¿¡å·å¯¹äºæŒ‡æ•°é¡¶éƒ¨çš„é¢„æµ‹æ•ˆæœæ˜æ˜¾ï¼ˆ2010.1.12-2023.8.30ï¼‰
    å›¾8ï¼šERPä¿¡å·å›æµ‹å‡€å€¼ï¼ˆ2010.6.30-2023.8.30ï¼‰
"""
# å›¾7:ERPä¿¡å·å¯¹äºæŒ‡æ•°é¡¶éƒ¨çš„é¢„æµ‹æ•ˆæœæ˜æ˜¾
# ä¸­è¯800æŒ‡æ•°æ»šåŠ¨å¸‚ç›ˆç‡ï¼ˆPE_TTMï¼‰ï¼Œæ•°æ®æ¥æºwind
# pe_ttm = pd.read_csv(r'./æ•°æ®/ä¸­è¯800æŒ‡æ•°æ»šåŠ¨å¸‚ç›ˆç‡ï¼ˆPE_TTMï¼‰.csv')
pe_ttm = pd.read_excel(r'./æ•°æ®/ä¸­è¯800æŒ‡æ•°æ»šåŠ¨å¸‚ç›ˆç‡ï¼ˆPE_TTMï¼‰.xlsx',sheet_name='Sheet1',index_col=0,header=3)
pe_ttm.index = pd.to_datetime(pe_ttm.index)
# ä¸­å›½10å¹´æœŸå›½å€ºæ”¶ç›Šç‡ï¼Œæ•°æ®æ¥æºhttps://cn.investing.com/rates-bonds/china-10-year-bond-yield-historical-data
# bond10 = pd.read_csv(r'./æ•°æ®/ä¸­å›½10å¹´æœŸå›½å€ºæ”¶ç›Šç‡cn.investing.com.csv')
# windï¼Œï¼ˆ%ï¼‰
bond10 = pd.read_excel(r'./æ•°æ®/å›½å€ºåˆ°æœŸæ”¶ç›Šç‡_10å¹´.xlsx',sheet_name='å›½å€ºåˆ°æœŸæ”¶ç›Šç‡_10å¹´(%)',index_col=0,header=0)
bond10.index = pd.to_datetime(bond10.index)
bond10 = bond10 / 100 # æ¢ç®—æˆå°æ•°å½¢å¼
p7 = pd.concat([pe_ttm,bond10],axis=1)
p7 = p7['2007-12-14':]
p7['ERP'] = 1/p7['pe_ttm'] - p7['å›½å€ºåˆ°æœŸæ”¶ç›Šç‡:10å¹´']

p7.dropna(inplace=True)
# ERPäº”å¹´åˆ†ä½æ•°
end_index = p7['2010-01-12':].index
for i in range(len(end_index)):
    p7.loc[end_index[i],'ERPäº”å¹´åˆ†ä½æ•°'] = stats.percentileofscore(p7.loc[end_index[i]-timedelta(days=1826):end_index[i],'ERP'], p7.loc[end_index[i],'ERP'], kind='rank',nan_policy='omit')
# æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡---çª—å£æœŸ120---alpha=1-(1/math.e)**(1/120)=0.01 æ•ˆæœå¤ªå·®
# ä¿®æ”¹ä¸ºçª—å£æœŸ=2ä¸ªäº¤æ˜“æ—¥
p7['ERPäº”å¹´åˆ†ä½æ•°'] = p7['ERPäº”å¹´åˆ†ä½æ•°'].ewm(alpha=1-(1/math.e)**(1/2),ignore_na=False,adjust=False).mean()
#%%
# # å›¾7å¯è§†åŒ–
fig, ax1 = plt.subplots(figsize=(8,4))
l1 = plt.fill_between(p7.index,p7['ERPäº”å¹´åˆ†ä½æ•°'],color = '#FFD306',label='ERPäº”å¹´åˆ†ä½æ•°(%)')
plt.xticks(rotation=30)
plt.xlim([p7['2010-01-12':].index[0],p7.index[-1]])  # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.ylim([0,100])
ax1.spines['top'].set_visible(False)
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(index_800.loc['2010-01-12':,'close'],color = '#003D79',lw=2.5,label='ä¸­è¯800æŒ‡æ•°(å³)')
plt.ylim([2000,6500])
plt.xlim([p7['2010-01-12':].index[0],p7.index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,1,12) for j in range(14)])
# å›¾ä¾‹åˆå¹¶
g = [l1, l2 ]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.title(u'å›¾7:ERPä¿¡å·å¯¹äºæŒ‡æ•°é¡¶éƒ¨çš„é¢„æµ‹æ•ˆæœæ˜æ˜¾')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾7ï¼šERPä¿¡å·å¯¹äºæŒ‡æ•°é¡¶éƒ¨çš„é¢„æµ‹æ•ˆæœæ˜æ˜¾.png',dpi=800)
#%%
"""å›¾8ï¼šä¸å¯¹åŠ²ğŸ¤¨"""
# å›¾8:ERPä¿¡å·å›æµ‹å‡€å€¼
p8 = pd.concat([equal_net_value[['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']],p7['ERPäº”å¹´åˆ†ä½æ•°']],axis=1)
p8['åŠ æƒERP'] = p8['ERPäº”å¹´åˆ†ä½æ•°']
"""æ—¶é—´è°ƒæ•´"""
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p8['date'] = p8.index
p8['yyyymm'] = p8.index.strftime('%Y-%m')
resize_list = p8.groupby(p8['yyyymm']).last()['date']
# åˆ†ä½æ•°
up = 80
down = 20
# ä¿¡å·
for i in resize_list:
    if p8.loc[i,'åŠ æƒERP'] > up:
        p8.loc[i,'signal'] = 1
    elif p8.loc[i,'åŠ æƒERP'] < down:
        p8.loc[i,'signal'] = -1
    else:
        p8.loc[i,'signal'] = 0
# ä»¥æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ä¹°å…¥å»ºä»“ï¼Œä»æ¬¡æœˆç¬¬ä¸€ä¸ªäº¤æ˜“æ—¥å¼€å§‹æŒä»“
for i in resize_list:
    if p8.loc[i,'signal'] == 1:
        p8.loc[i,'å»ºä»“te'] = 1
    elif p8.loc[i,'signal'] == -1:
        p8.loc[i,'å»ºä»“te'] = -1
    else:
        p8.loc[i,'å»ºä»“te'] = 0
p8['å»ºä»“'] = p8['å»ºä»“te'].shift(1)
p8 = p8.fillna(method='ffill')
condition1 = p8['å»ºä»“'] == 1
p8.loc[condition1,'æŒä»“'] = 1 * (1+0.3)
condition2 = p8['å»ºä»“'] == -1
p8.loc[condition2,'æŒä»“'] = -1
# è®¡ç®—å‡€å€¼
p8['åŠ æƒERPæ¶¨è·Œå¹…'] =  p8['æŒä»“'] * p8['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] 
p8['åŠ æƒERPå‡€å€¼'] = (1+p8['åŠ æƒERPæ¶¨è·Œå¹…']).cumprod()
p8['åŠ æƒERPå‡€å€¼'] = p8['åŠ æƒERPå‡€å€¼'].fillna(method='ffill')
condition = p8['åŠ æƒERPå‡€å€¼'].dropna().index
p8.loc[condition,'æŒ‡æ•°å‡€å€¼'] = (1 + p8.loc[condition,'ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
p8.loc['2010-06-30','æŒ‡æ•°å‡€å€¼'] = 1
p8.loc['2010-06-30','åŠ æƒERPå‡€å€¼'] = 1
# å¯è§†åŒ–â€”â€”â€”â€”å›¾8:ERPä¿¡å·å›æµ‹å‡€å€¼
fig, ax1 = plt.subplots(figsize=(8,4))
l1 = plt.fill_between(p8.index,p8['ERPäº”å¹´åˆ†ä½æ•°'],color = '#FFD306',label='ERPäº”å¹´åˆ†ä½æ•°(%)')
plt.xticks(rotation=30)
plt.xlim([p8['åŠ æƒERPå‡€å€¼'].dropna().index[0],p8['åŠ æƒERPå‡€å€¼'].dropna().index[-1]])  # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.ylim([0,100])
ax1.spines['top'].set_visible(False)
# plt.axhline(y=up, color='darkred', linestyle='--', linewidth=1)
# plt.axhline(y=down, color='darkred', linestyle='--', linewidth=1)
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(p8['æŒ‡æ•°å‡€å€¼'], color='midnightblue',label='ä¸­è¯800å‡€å€¼(å³)') 
l3, = plt.plot(p8['åŠ æƒERPå‡€å€¼'], color='royalblue',label='åŠ æƒERPå‡€å€¼(å³)') 
plt.xlim([p8['åŠ æƒERPå‡€å€¼'].dropna().index[0],p8['åŠ æƒERPå‡€å€¼'].dropna().index[-1]])  # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
# plt.axhline(y=1, color='red', linestyle='--', linewidth=1)
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,6,30) for j in range(14)])
plt.ylim([0,3])
plt.title('å›¾8:ERPä¿¡å·å›æµ‹å‡€å€¼')
# å›¾ä¾‹åˆå¹¶
g = [l1, l2, l3]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9,loc=9)
plt.tight_layout()
plt.savefig('./output/å›¾8ï¼šERPä¿¡å·å›æµ‹å‡€å€¼.png',dpi=800)
#%%
"""
4.1.2 è‚¡ç¥¨é‡ä»·æŒ‡æ ‡.. 16 
    å›¾9ï¼šMAï¼ˆ5ï¼‰ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœï¼ˆ2010.3.31-2023.8.30ï¼‰
    å›¾ï¼šå•ç‹¬çš„æˆäº¤é‡ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ(2010.6.30-2023.8.30)
    å›¾ï¼šé‡ä»·æŒ‡æ ‡ï¼šæ”¾é‡ä¸Šæ¶¨+ç ´å‡çº¿ä¸‹è·Œåœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ(2010.8.31-2023.8.30)
    è¡¨10ï¼šé‡ä»·ä¿¡å·ç»“åˆè¡¨ç°(2010.8.31-2023.8.30)
"""
# å›¾9ï¼šMAï¼ˆ5ï¼‰ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ
# å•ç‹¬çš„è‚¡ç¥¨MAä¿¡å·â€”â€”â€”â€”æ”¶ç›˜ä»·è¿‘Næ—¥å‡çº¿
N = 5
p9 = equal_net_value[['close','ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']]
p9['MA_close'] = p9['close'].rolling(window= N ).mean()
condition1 = p9['MA_close'] < p9['close']
condition2 = p9['MA_close'] > p9['close']
p9.loc[condition1,'signal'] = 1
p9.loc[condition2,'signal'] = -1
p9 = p9.loc['2010-03-31':,:]
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p9['date'] = p9.index
p9['yyyymm'] = p9.index.strftime('%Y-%m')
resize_list = p9.groupby(p9['yyyymm']).last()['date']
# ä»¥æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ä¹°å…¥å»ºä»“ï¼Œä»æ¬¡æœˆç¬¬ä¸€ä¸ªäº¤æ˜“æ—¥å¼€å§‹æŒä»“
for i in resize_list:
    if p9.loc[i,'signal'] == 1:
        p9.loc[i,'å»ºä»“te'] = 1
    elif p9.loc[i,'signal'] == -1:
        p9.loc[i,'å»ºä»“te'] = -1
    else:
        p9.loc[i,'å»ºä»“te'] = 0
p9['å»ºä»“'] = p9['å»ºä»“te'].shift(1)
p9 = p9.fillna(method='ffill')
condition1 = p9['å»ºä»“'] == 1
p9.loc[condition1,'æŒä»“'] = 1
condition2 = p9['å»ºä»“'] == -1
p9.loc[condition2,'æŒä»“'] = -1
p9['MA(5)æŒä»“æ¶¨è·Œå¹…'] = p9['æŒä»“'] * p9['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']
p9['MA(5)æŒä»“å‡€å€¼']  = (1+p9['MA(5)æŒä»“æ¶¨è·Œå¹…']).cumprod()
p9['MA(5)æŒä»“å‡€å€¼'] = p9['MA(5)æŒä»“å‡€å€¼'].fillna(method='ffill')
p9.loc[p9['MA(5)æŒä»“å‡€å€¼'].dropna().index,'æŒ‡æ•°å‡€å€¼'] = (1 + p9.loc[p9['MA(5)æŒä»“å‡€å€¼'].dropna().index,'ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
p9.loc['2010-03-31',['MA(5)æŒä»“å‡€å€¼','æŒ‡æ•°å‡€å€¼']] = 1
p9['è¶…é¢'] = p9['MA(5)æŒä»“å‡€å€¼'] - p9['æŒ‡æ•°å‡€å€¼'] 
# å›¾9å¯è§†åŒ–
fig, ax1 = plt.subplots(figsize=(9,4))
l1 = plt.fill_between(p9.index,p9['è¶…é¢'],color = '#FFD306',label='è¶…é¢')
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
ax1.spines['top'].set_visible(False)
plt.xlim([p8.index[0],p8.index[-1]])
plt.ylim([-0.5,3.5])
plt.yticks([-0.5,0.0,0.5,1.0,1.5,2.0,2.5,3.0,3.5])
ax2 = plt.twinx()
l2, = plt.plot(p9['MA(5)æŒä»“å‡€å€¼'], color='royalblue',label='MAï¼ˆ5ï¼ŒNï¼Œå¤šç©ºï¼‰(å³)')
l3, = plt.plot(p9['æŒ‡æ•°å‡€å€¼'],color='midnightblue',label='æŒ‡æ•°å‡€å€¼(å³)')
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,3,31) for j in range(14)])
ax2.spines['top'].set_visible(False)
plt.title('å›¾9ï¼šMAï¼ˆ5ï¼‰ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ')
plt.xlim([p9.index[0],p9.index[-1]])
plt.ylim([0.5,4.5])
plt.yticks([0.5,1.0,1.5,2.0,2.5,3.0,3.5,4.0,4.5])
# å›¾ä¾‹åˆå¹¶
g = [l1, l2, l3]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.tight_layout()
plt.savefig('./output/å›¾9ï¼šMAï¼ˆ5ï¼‰ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ.png',dpi=800)
#%%
# æˆäº¤é‡è¿‘Mæ—¥å‡çº¿
M = 5
# volume_800 = pd.read_excel(r'./æ•°æ®/800æ”¶ç›Šåå¤æƒ.xlsx',sheet_name='Sheet2',index_col=0,header=3)
volume_800 = pd.read_excel(r'./æ•°æ®/800æ”¶ç›Šä¸å¤æƒ.xlsx',sheet_name='Sheet1',index_col=0,header=3)
volume_800.index = pd.to_datetime(volume_800.index)
volume_800.rename(columns={'volume':'ä¸­è¯800æˆäº¤é‡'},inplace=True)
volume_800['æˆäº¤é‡M='+str(M)] = volume_800['ä¸­è¯800æˆäº¤é‡'].rolling(window = M ).mean()
volume_800 = volume_800[['æˆäº¤é‡M='+str(M),'ä¸­è¯800æˆäº¤é‡']]
volume_800 = pd.concat([volume_800,equal_net_value['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']],axis=1)
# ä¿¡å·
condition1 = volume_800['æˆäº¤é‡M='+str(M)]  < volume_800['ä¸­è¯800æˆäº¤é‡']
volume_800.loc[condition1,'signal'] = 1
# ä»¥æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ä¹°å…¥å»ºä»“ï¼Œä»æ¬¡æœˆç¬¬ä¸€ä¸ªäº¤æ˜“æ—¥å¼€å§‹æŒä»“
for i in resize_list:
    if volume_800.loc[i,'signal'] == 1:
        volume_800.loc[i,'å»ºä»“te'] = 1
    else :
        volume_800.loc[i,'å»ºä»“te'] = 0
volume_800['å»ºä»“'] = volume_800['å»ºä»“te'].shift(1)
volume_800 = volume_800.fillna(method='ffill')
condition = volume_800['å»ºä»“'] == 1
volume_800.loc[condition,'æŒä»“'] = 1
volume_800 = volume_800.loc['2010-06-30':,:]
# è®¡ç®—å‡€å€¼
volume_800['æŒä»“æ¶¨è·Œå¹…'] = volume_800['æŒä»“'] * volume_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] 
volume_800['æŒä»“å‡€å€¼']  = (1+volume_800['æŒä»“æ¶¨è·Œå¹…']).cumprod()
volume_800['æŒä»“å‡€å€¼'] = volume_800['æŒä»“å‡€å€¼'].fillna(method='ffill')
volume_800.loc[volume_800['æŒä»“å‡€å€¼'].dropna().index,'æŒ‡æ•°å‡€å€¼'] = (1 + volume_800.loc[volume_800['æŒä»“å‡€å€¼'].dropna().index,'ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
volume_800['è¶…é¢'] = volume_800['æŒä»“å‡€å€¼'] - volume_800['æŒ‡æ•°å‡€å€¼'] 
volume_800.loc['2010-06-30',['æŒä»“å‡€å€¼','æŒ‡æ•°å‡€å€¼']] = 1
# å¯è§†åŒ–â€”â€”å•ç‹¬çš„æˆäº¤é‡ä¿¡å·M=5
fig, ax1 = plt.subplots(figsize=(9,4))
l1 = plt.fill_between(volume_800.index,volume_800['è¶…é¢'],color = '#FFD306',label='è¶…é¢')
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
ax1.spines['top'].set_visible(False)
plt.ylim([-0.5,2])
plt.xlim([p8.index[0],p8.index[-1]])
ax2 = plt.twinx()
l2, = plt.plot(volume_800['æŒä»“å‡€å€¼'], color='royalblue',label='æˆäº¤é‡ï¼ˆ5ï¼ŒMï¼Œå¤šå¤´ï¼‰(å³)')
l3, = plt.plot(volume_800['æŒ‡æ•°å‡€å€¼'],color='midnightblue',label='æŒ‡æ•°å‡€å€¼(å³)')
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,6,30) for j in range(14)])
ax2.spines['top'].set_visible(False)
plt.title('å•ç‹¬çš„æˆäº¤é‡ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ')
plt.xlim([volume_800['æŒä»“å‡€å€¼'].dropna().index[0],volume_800['æŒä»“å‡€å€¼'].dropna().index[-1]])
plt.ylim([0.5,4])
# å›¾ä¾‹åˆå¹¶
g = [l1, l2, l3]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9,loc=2)
plt.tight_layout()
plt.savefig('./output/å•ç‹¬çš„æˆäº¤é‡ä¿¡å·åœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ.png',dpi=800)
#%%
# è¡¨10:é‡ä»·ä¿¡å·ç»“åˆè¡¨ç°â€”â€”å‡çº¿å’Œæˆäº¤é‡åŒæ—¶å‘å‡ºçœ‹å¤šä¿¡å·ï¼Œä¹°å…¥ï¼›å½“å‡çº¿å‘å‡ºçœ‹ç©ºä¿¡å·æ—¶ï¼Œå–å‡º
t10 = pd.concat([volume_800[['æˆäº¤é‡M='+str(M),'ä¸­è¯800æˆäº¤é‡']],p9[['close','MA_close','ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']]],axis=1)
# æŒ‰ä¸Šè¿°å®æ“å›æµ‹ç»“æœ80æ•ˆæœæ˜¾è‘—ï¼Œæ”¹æˆ80
condition1 = t10['ä¸­è¯800æˆäº¤é‡'] > t10['æˆäº¤é‡M='+str(M)]
condition2 = t10['close'] > t10['MA_close']
condition3 = t10['close'] < t10['MA_close']
# æ„å»ºä¿¡å·
t10.loc[condition1,'æˆäº¤é‡M='+str(M)+'signal'] = 1
t10.loc[condition2,'å‡çº¿signal'] = 1
t10.loc[condition3,'å‡çº¿signal'] = -1
t10.loc[condition1&condition2,'å¤šå¤´signal'] = 1
t10.loc[condition1&condition2,'å¤šç©ºsignal'] = 1
t10.loc[condition3,'å¤šç©ºsignal'] = -1
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
t10['date'] = t10.index
t10['yyyymm'] = t10.index.strftime('%Y-%m')
resize_list = t10.groupby(p8['yyyymm']).last()['date']
for i in resize_list:
    # æˆäº¤é‡ä¿¡å·å»ºä»“
    if t10.loc[i,'æˆäº¤é‡M='+str(M)+'signal'] == 1:
        t10.loc[i,'æˆäº¤é‡M='+str(M)+'å»ºä»“te'] = 1
    else :
        t10.loc[i,'æˆäº¤é‡M='+str(M)+'å»ºä»“te'] = 0
    # å‡çº¿ä¿¡å·å»ºä»“
    if t10.loc[i,'å‡çº¿signal'] == 1:
        t10.loc[i,'å‡çº¿å»ºä»“te'] = 1
    elif t10.loc[i,'å‡çº¿signal'] == -1:
        t10.loc[i,'å‡çº¿å»ºä»“te'] = -1
    else:
        t10.loc[i,'å‡çº¿å»ºä»“te'] = 0
    # å¤šå¤´ä¿¡å·å»ºä»“
    if t10.loc[i,'å¤šå¤´signal'] == 1:
        t10.loc[i,'å¤šå¤´å»ºä»“te'] = 1
    else:
        t10.loc[i,'å¤šå¤´å»ºä»“te'] = 0
    # å¤šç©ºä¿¡å·å»ºä»“
    if t10.loc[i,'å¤šç©ºsignal'] == 1:
        t10.loc[i,'å¤šç©ºå»ºä»“te'] = 1
    elif t10.loc[i,'å¤šç©ºsignal'] == -1:
        t10.loc[i,'å¤šç©ºå»ºä»“te'] = -1
    else:
        t10.loc[i,'å¤šç©ºå»ºä»“te'] = 0
pos_list = ['æˆäº¤é‡M='+str(M)+'å»ºä»“','å‡çº¿å»ºä»“','å¤šå¤´å»ºä»“','å¤šç©ºå»ºä»“']
for i in pos_list:
    t10[i] = t10[i+'te'].shift(1)
    t10[i] = t10[i].fillna(method='ffill')
# t10 = t10.fillna(method='ffill')
for i in pos_list:
    condition1 = t10[i] == 1
    condition2 = t10[i] == -1
    t10.loc[condition1,i[:-2]+'æŒä»“'] = 1
    t10.loc[condition2,i[:-2]+'æŒä»“'] = -1
# å„ä¸ªæŒ‡æ ‡å‘å‡ºçš„å»ºä»“ä¿¡å·çš„èµ·å§‹æ—¶é—´ä¸ä¸€è‡´
# è¿™é‡Œç»Ÿä¸€ä¸º2010-8-31å„ä¸ªæŒ‡æ ‡å‡å‘å‡ºå»ºä»“ä¿¡å·çš„æœ€æ—©æ—¥æœŸ
t10 = t10.loc['2010-8-31':,:]
for i in pos_list:
    t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…'] = t10[i[:-2]+'æŒä»“'] * t10['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']
    t10[i[:-2]+'æŒä»“å‡€å€¼'] = (1 + t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
    t10[i[:-2]+'æŒä»“å‡€å€¼'] = t10[i[:-2]+'æŒä»“å‡€å€¼'].fillna(method='ffill')
t10.loc[t10['å¤šç©ºæŒä»“å‡€å€¼'].dropna().index,'æŒ‡æ•°å‡€å€¼'] = (1 + t10.loc[t10['å¤šç©ºæŒä»“å‡€å€¼'].dropna().index,'ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
t10.loc['2010-8-31',['å‡çº¿æŒä»“å‡€å€¼','æˆäº¤é‡M='+str(M)+'æŒä»“å‡€å€¼','å¤šç©ºæŒä»“å‡€å€¼','æŒ‡æ•°å‡€å€¼','å¤šå¤´æŒä»“å‡€å€¼']] = 1
# å¯è§†åŒ–è¡¨10â€”â€”é‡ä»·æŒ‡æ ‡ï¼šæ”¾é‡ä¸Šæ¶¨+ç ´å‡çº¿ä¸‹è·Œ
fig, ax1 = plt.subplots(figsize=(9,4))
color_list = ['darkorange','gold','lightsteelblue','royalblue']
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
for i in range(len(pos_list)):
    plt.plot(t10[pos_list[i][:-2]+'æŒä»“å‡€å€¼'], color=color_list[i] ,label=pos_list[i][:-2])
plt.plot(t10.loc[t10['å¤šç©ºæŒä»“å‡€å€¼'].dropna().index,'æŒ‡æ•°å‡€å€¼'] ,color='midnightblue',label='æŒ‡æ•°å‡€å€¼')
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,8,31) for j in range(14)])
plt.title('é‡ä»·æŒ‡æ ‡ï¼šæ”¾é‡ä¸Šæ¶¨+ç ´å‡çº¿ä¸‹è·Œåœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ')
plt.xlim([t10.index[0],t10.index[-1]])
plt.tight_layout()
plt.legend(fontsize=9)
plt.savefig('./output/é‡ä»·æŒ‡æ ‡ï¼šæ”¾é‡ä¸Šæ¶¨+ç ´å‡çº¿ä¸‹è·Œåœ¨ä¸­è¯800æŒ‡æ•°ä¸Šçš„æ‹©æ—¶æ•ˆæœ.png',dpi=800)
#%%
# è¡¨10:é‡ä»·ä¿¡å·ç»“åˆè¡¨ç°
t10_ = pd.DataFrame()
# åŸå§‹
t10_.loc['è°ƒä»“é¢‘ç‡','åŸå§‹'] = 'M'
t10_.loc['ç´¯è®¡å‡€å€¼','åŸå§‹'] = Performance(t10['æŒ‡æ•°å‡€å€¼'].dropna()).accumulate_net_value()
t10_.loc['åˆè®¡å‘¨æœŸ','åŸå§‹'] = len(resize_list)
t10_.loc['ä¿¡å·æ¬¡æ•°','åŸå§‹'] = len(resize_list)
t10_.loc['å¤šå¤´','åŸå§‹'] = len(resize_list)
t10_.loc['ç©ºå¤´','åŸå§‹'] = 0
condition = t10.loc[t10['æŒ‡æ•°å‡€å€¼'].dropna().index,'ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']
t10_.loc['èƒœç‡','åŸå§‹'] = round(len(condition[condition>0]) / len(condition),2)
t10_.loc['ç›ˆäºæ¯”','åŸå§‹'] = round(len(condition[condition>0])/len(condition[condition<0]),2)
t10_.loc['æœŸæœ›','åŸå§‹'] = Statistic_data(resize_list,resize_list,condition).expectation()
t10_.loc['å¹´åŒ–æ”¶ç›Š','åŸå§‹'] = Performance(t10['æŒ‡æ•°å‡€å€¼'].dropna()).annualized_returns 
t10_.loc['æ³¢åŠ¨','åŸå§‹'] = Performance(t10['æŒ‡æ•°å‡€å€¼'].dropna()).annualized_volatility
t10_.loc['å¤æ™®','åŸå§‹'] = Performance(t10['æŒ‡æ•°å‡€å€¼'].dropna()).cal_sharp()
t10_.loc['æœ€å¤§å›æ’¤','åŸå§‹'] = Performance(t10['æŒ‡æ•°å‡€å€¼'].dropna()).max_drawdown()
for i in pos_list:
    t10_.loc['è°ƒä»“é¢‘ç‡',i[:-2]] = 'M'
    t10_.loc['ç´¯è®¡å‡€å€¼',i[:-2]] = Performance(t10[i[:-2]+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
    t10_.loc['åˆè®¡å‘¨æœŸ',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
    t10_.loc['ä¿¡å·æ¬¡æ•°',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
    t10_.loc['å¤šå¤´',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
    t10_.loc['ç©ºå¤´',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
    t10_.loc['èƒœç‡',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
    t10_.loc['ç›ˆäºæ¯”',i[:-2]] = Statistic_data(resize_list, t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
    t10_.loc['æœŸæœ›',i[:-2]] = Statistic_data(resize_list,t10[i[:-2]+'å»ºä»“te'],t10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']).expectation()
    t10_.loc['å¹´åŒ–æ”¶ç›Š',i[:-2]] = Performance(t10[i[:-2]+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
    t10_.loc['æ³¢åŠ¨',i[:-2]] =  Performance(t10[i[:-2]+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
    t10_.loc['å¤æ™®',i[:-2]] =  Performance(t10[i[:-2]+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
    t10_.loc['æœ€å¤§å›æ’¤',i[:-2]] =  Performance(t10[i[:-2]+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t10_.to_excel(r'./output/è¡¨10ï¼šé‡ä»·ä¿¡å·ç»“åˆè¡¨ç°.xlsx')
#%%
"""
4.1.3 åˆæˆä¿¡å·. ..18 
    å›¾10ï¼šåˆæˆæŒ‡æ ‡å‡€å€¼(2010.6.30-2023.8.30)
    å›¾11ï¼šåˆæˆæŒ‡æ ‡å›æ’¤(2010.6.30-2023.8.30)
    è¡¨11ï¼šERP+é‡ä»·æŒ‡æ ‡ä¿¡å·(2010.6.30-2023.8.30)
"""
# å›¾10ï¼šåˆæˆæŒ‡æ ‡å‡€å€¼
# ERP+é‡ä»·â€”â€”åŠ ä»“/å‡ä»“ ,'åŠ æƒERPå‡€å€¼',t10['å¤šç©ºæŒä»“å‡€å€¼']
p10 = pd.concat([p8[['åŠ æƒERP']],volume_800[['æˆäº¤é‡M='+str(M),'ä¸­è¯800æˆäº¤é‡']],p9[['close','MA_close','ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']]],axis=1)
# çœ‹å¤šä¿¡å·
condition1 = p10['åŠ æƒERP'] > up
condition2 = p10['close'] > p10['MA_close']
condition3 = p10['ä¸­è¯800æˆäº¤é‡'] > p10['æˆäº¤é‡M='+str(M)]
# çœ‹ç©ºä¿¡å·
condition4 = p10['åŠ æƒERP'] < down
condition5 = p10['close'] < p10['MA_close']
# signal
p10.loc[condition1,'åŠ æƒERPä¿¡å·signal'] = 1
p10.loc[condition4,'åŠ æƒERPä¿¡å·signal'] = -1
p10['åŠ æƒERPä¿¡å·signal'] = p10['åŠ æƒERPä¿¡å·signal'].fillna(value=0)
p10.loc[condition2&condition3,'é‡ä»·ä¿¡å·signal'] = 1
p10.loc[condition5,'é‡ä»·ä¿¡å·signal'] = -1
p10['é‡ä»·ä¿¡å·signal'] = p10['é‡ä»·ä¿¡å·signal'].fillna(value=0) 
p10['ä¿¡å·ç»“åˆsignal'] = p10['åŠ æƒERPä¿¡å·signal'] + p10['é‡ä»·ä¿¡å·signal']
p10 = p10.loc['2010-6-30':,:]
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p10['date'] = p10.index
p10['yyyymm'] = p10.index.strftime('%Y-%m')
resize_list = p10.groupby(p10['yyyymm']).last()['date']
# # signal
for i in resize_list:
    # ä¿¡å·ç»“åˆï¼ˆå¤šç©º\å¤šå¤´ï¼‰
    if p10.loc[i,'ä¿¡å·ç»“åˆsignal'] == 2:
        p10.loc[i,'ä¿¡å·ç»“åˆå»ºä»“te'] = 1
        p10.loc[i,'ä¿¡å·ç»“åˆå¤šå¤´å»ºä»“te'] = 1
    elif p10.loc[i,'ä¿¡å·ç»“åˆsignal'] == -2:
        p10.loc[i,'ä¿¡å·ç»“åˆå»ºä»“te'] = -1
    else:
        p10.loc[i,'ä¿¡å·ç»“åˆå»ºä»“te'] = 0
        p10.loc[i,'ä¿¡å·ç»“åˆå¤šå¤´å»ºä»“te'] = 0
    # åŠ æƒERPä¿¡å·
    if p10.loc[i,'åŠ æƒERPä¿¡å·signal'] == 1:
        p10.loc[i,'åŠ æƒERPä¿¡å·å»ºä»“te'] = 1
    elif p10.loc[i,'åŠ æƒERPä¿¡å·signal'] == -1:
        p10.loc[i,'åŠ æƒERPä¿¡å·å»ºä»“te'] = -1
    else:
        p10.loc[i,'åŠ æƒERPä¿¡å·å»ºä»“te'] = 0
    # é‡ä»·ä¿¡å·
    if p10.loc[i,'é‡ä»·ä¿¡å·signal'] == 1:
        p10.loc[i,'é‡ä»·ä¿¡å·å»ºä»“te'] = 1
    elif p10.loc[i,'é‡ä»·ä¿¡å·signal'] == -1:
        p10.loc[i,'é‡ä»·ä¿¡å·å»ºä»“te'] = -1
    else: 
        p10.loc[i,'é‡ä»·ä¿¡å·å»ºä»“te'] = 0

pos_list = ['ä¿¡å·ç»“åˆå»ºä»“','ä¿¡å·ç»“åˆå¤šå¤´å»ºä»“','åŠ æƒERPä¿¡å·å»ºä»“','é‡ä»·ä¿¡å·å»ºä»“']
for i in pos_list:
    p10[i] = p10[i+'te'].shift(1)
    p10[i] = p10[i].fillna(method='ffill')
for i in pos_list:
    condition1 = p10[i] == 1
    condition2 = p10[i] == -1
    p10.loc[condition1,i[:-2]+'æŒä»“'] = 1 
    p10.loc[condition2,i[:-2]+'æŒä»“'] = -1
# è®¡ç®—å‡€å€¼
for i in pos_list:
    p10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…'] = p10[i[:-2]+'æŒä»“'] * p10['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']* (1+0.5)
    p10[i[:-2]+'æŒä»“å‡€å€¼'] = 1 + p10[i[:-2]+'æŒä»“æ¶¨è·Œå¹…']
    p10.loc['2010-6-30',i[:-2]+'æŒä»“å‡€å€¼'] = 1
    p10[i[:-2]+'æŒä»“å‡€å€¼'] = p10[i[:-2]+'æŒä»“å‡€å€¼'].cumprod()
    p10[i[:-2]+'æŒä»“å‡€å€¼'] = p10[i[:-2]+'æŒä»“å‡€å€¼'].fillna(method='ffill')
for i in resize_list:
    p10.loc[i,'æŒ‡æ•°å»ºä»“te'] = 1
p10['æŒ‡æ•°æŒä»“æ¶¨è·Œå¹…'] = p10['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']
p10['æŒ‡æ•°æŒä»“å‡€å€¼'] = 1 + p10['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']
p10.loc['2010-6-30','æŒ‡æ•°æŒä»“å‡€å€¼'] = 1
p10['æŒ‡æ•°æŒä»“å‡€å€¼'] = p10['æŒ‡æ•°æŒä»“å‡€å€¼'].cumprod()
# å¯è§†åŒ–â€”â€”â€”â€”å›¾10ï¼šåˆæˆæŒ‡æ ‡å‡€å€¼
fig, ax1 = plt.subplots(figsize=(9,4))
color_list = ['red','royalblue','gold']
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
pos_list = ['ä¿¡å·ç»“åˆå»ºä»“','åŠ æƒERPä¿¡å·å»ºä»“','é‡ä»·ä¿¡å·å»ºä»“']
for i in range(len(pos_list)):
    plt.plot(p10[pos_list[i][:-2]+'æŒä»“å‡€å€¼'], color=color_list[i] ,label=pos_list[i][:-2])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks([dt.datetime(2010+j,6,30) for j in range(14)])
plt.xticks(rotation=30)
plt.title('å›¾10ï¼šåˆæˆæŒ‡æ ‡å‡€å€¼')
plt.ylim([0,6])
plt.xlim([p10['ä¿¡å·ç»“åˆæŒä»“å‡€å€¼'].dropna().index[0],p10['ä¿¡å·ç»“åˆæŒä»“å‡€å€¼'].dropna().index[-1]])
plt.legend(fontsize=9)
plt.tight_layout()
plt.savefig('./output/å›¾10ï¼šåˆæˆæŒ‡æ ‡å‡€å€¼.png',dpi=800)
#%%
# å›¾11:åˆæˆæŒ‡æ ‡å›æ’¤
# å¯è§†åŒ–â€”â€”â€”â€”å›¾11:åˆæˆæŒ‡æ ‡å›æ’¤
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
ax1.spines['bottom'].set_visible(False)
plt.plot(drawdown(p10['ä¿¡å·ç»“åˆæŒä»“å‡€å€¼'].dropna()),color='royalblue',label='åˆæˆæŒ‡æ ‡å›æ’¤')
plt.plot(drawdown(p10['æŒ‡æ•°æŒä»“å‡€å€¼'].dropna()),color='gold',label='åŸå§‹å›æ’¤')
plt.axhline(y=0, color='black', linestyle='-', linewidth=0.9)
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2010+j,6,30) for j in range(14)])
plt.xlim([p10['ä¿¡å·ç»“åˆæŒä»“å‡€å€¼'].dropna().index[0],p10['ä¿¡å·ç»“åˆæŒä»“å‡€å€¼'].dropna().index[-1]])
plt.ylim([-0.6,0])
plt.title('å›¾11:åˆæˆæŒ‡æ ‡å›æ’¤')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾11ï¼šåˆæˆæŒ‡æ ‡å›æ’¤.png',dpi=800)
#%%
# è¡¨11:ERP+é‡ä»·æŒ‡æ ‡ä¿¡å·
t11 = pd.DataFrame()
name_list =  p10[['æŒ‡æ•°æŒä»“å‡€å€¼','ä¿¡å·ç»“åˆå¤šå¤´æŒä»“å‡€å€¼','ä¿¡å·ç»“åˆæŒä»“å‡€å€¼']].columns
for i in name_list:
    t11.loc['è°ƒä»“é¢‘ç‡',i[:-4]] = 'M'
    t11.loc['ç´¯è®¡å‡€å€¼',i[:-4]] = Performance(p10[i[:-4]+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
    t11.loc['åˆè®¡å‘¨æœŸ',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
    t11.loc['ä¿¡å·æ¬¡æ•°',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
    t11.loc['å¤šå¤´',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
    t11.loc['ç©ºå¤´',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
    t11.loc['èƒœç‡',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
    t11.loc['ç›ˆäºæ¯”',i[:-4]] = Statistic_data(resize_list, p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
    t11.loc['æœŸæœ›',i[:-4]] = Statistic_data(resize_list,p10[i[:-4]+'å»ºä»“te'],p10[i[:-4]+'æŒä»“æ¶¨è·Œå¹…']).expectation()
    t11.loc['å¹´åŒ–æ”¶ç›Š',i[:-4]] = Performance(p10[i[:-4]+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
    t11.loc['æ³¢åŠ¨',i[:-4]] =  Performance(p10[i[:-4]+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
    t11.loc['å¤æ™®',i[:-4]] =  Performance(p10[i[:-4]+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
    t11.loc['æœ€å¤§å›æ’¤',i[:-4]] =  Performance(p10[i[:-4]+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t11.to_excel(r'./output/è¡¨11ï¼šERP+é‡ä»·æŒ‡æ ‡ä¿¡å·.xlsx')
#%%
"""
4.2 é»„é‡‘æ‹©æ—¶æŒ‡æ ‡..... 20 
4.2.1åå¹´æœŸç¾å€ºå®é™…æ”¶ç›Šç‡.... .21 
    å›¾13ï¼šé»„é‡‘å’Œç¾å€ºå®é™…æ”¶ç›Šç‡è´Ÿç›¸å…³æ€§æ˜æ˜¾(2004.1.2-2023.8.30)
    å›¾14ï¼šç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ(2004.2.27-2023.8.30)
    è¡¨14ï¼šç¾å€ºå‡çº¿æŒ‡æ ‡ä¸åŒå‚æ•°å¤šç©ºæ•ˆæœ(2004.2.27-2023.8.30)
"""
# æŒ‡æ ‡å‡†å¤‡
# 10å¹´æœŸç¾å€ºå®é™…æ”¶ç›Šç‡ï¼ˆTIPSæ”¶ç›Šç‡ï¼‰å’ŒCBOEçš„VIXæŒ‡æ•°
# tips_vix = pd.read_excel('/Users/gulining/Downloads/ç ”ç©¶ç”Ÿ-/è¯¾ç¨‹èµ„æ–™/ç ”ä¸€ä¸‹/ï¼ˆç ”ï¼‰Pythonä¸é‡‘èæ•°æ®åˆ†æï¼ˆ22-23-2ï¼‰/æœŸæœ«è€ƒæ ¸/æ•°æ®/TIPSæ”¶ç›Šç‡&VIXæŒ‡æ•°.xlsx',sheet_name='Sheet1',index_col=0,header=3)
tips_vix = pd.read_excel(r'./æ•°æ®/TIPSæ”¶ç›Šç‡&VIXæŒ‡æ•°.xlsx',sheet_name='Sheet1',index_col=0,header=2)
tips_vix = tips_vix.iloc[1:,:]
tips_vix.index = pd.to_datetime(tips_vix.index)
tips_vix.rename(columns={'10Yç¾å›½å›½å€ºæ”¶ç›Šç‡(ä»¥é€šèƒ€ä¸ºæ ‡çš„)':'TIPSæ”¶ç›Šç‡',
                         'CBOEæ³¢åŠ¨ç‡':'VIXæŒ‡æ•°'},inplace=True)
# å¯è§†åŒ–â€”â€”â€”â€”å›¾13:é»„é‡‘å’Œç¾å€ºå®é™…æ”¶ç›Šç‡è´Ÿç›¸å…³æ€§æ˜æ˜¾
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
l1, = plt.plot(tips_vix['TIPSæ”¶ç›Šç‡'],color='royalblue',label='åå¹´æœŸç¾å€ºæ”¶ç›Šç‡')
ax1.spines['bottom'].set_position(('data', 0))
plt.ylim([-1.5,3.5])
plt.yticks([-1.5,-1,-0.5,0,0.5,1,1.5,2,2.5,3,3.5])
plt.xticks(rotation=30)
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(au9999['Au'],color='gold',label='é»„é‡‘ä»·æ ¼(å³)')
ax2.spines['bottom'].set_position(('data', 150))
plt.ylim([0,500])
plt.yticks([0,50,100,150,200,250,300,350,400,450,500])
plt.xlim([au9999.index[0],au9999.index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2004+j,1,2) for j in range(20)])
# # å›¾ä¾‹åˆå¹¶
g =[ l1,l2 ]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.title('å›¾13:é»„é‡‘å’Œç¾å€ºå®é™…æ”¶ç›Šç‡è´Ÿç›¸å…³æ€§æ˜æ˜¾')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾13ï¼šé»„é‡‘å’Œç¾å€ºå®é™…æ”¶ç›Šç‡è´Ÿç›¸å…³æ€§æ˜æ˜¾.png',dpi=800)
#%%
p14 = pd.concat([tips_vix['TIPSæ”¶ç›Šç‡'],au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],axis=1)
# å›¾14:ç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ
resize_list_au,long_short_N20 = signal_count_net_value_au(daily_return_df=p14[['TIPSæ”¶ç›Šç‡','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],N=20,name='å¤šç©º')
p14['å¤šç©ºæŒä»“å‡€å€¼']  = long_short_N20['å¤šç©ºæŒä»“å‡€å€¼']
p14.loc[p14['å¤šç©ºæŒä»“å‡€å€¼'].dropna().index,'åŸå§‹å‡€å€¼'] = (1 + p14.loc[p14['å¤šç©ºæŒä»“å‡€å€¼'].dropna().index,'ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']).cumprod()
p14.loc['2004-2-27',['åŸå§‹å‡€å€¼','å¤šç©ºæŒä»“å‡€å€¼']] = 1
p14['è¶…é¢'] = p14['å¤šç©ºæŒä»“å‡€å€¼'] - p14['åŸå§‹å‡€å€¼']
# å¯è§†åŒ–â€”â€”â€”â€”å›¾14:ç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
l1 = ax1.fill_between(p14['è¶…é¢'].index,p14['è¶…é¢'],label='è¶…é¢',color = 'orange',interpolate=True,alpha=0.7)
plt.ylim([-1,5])
plt.xticks(rotation=30)
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(p14['å¤šç©ºæŒä»“å‡€å€¼'],color='darkblue',label='ç¾å€ºå‡çº¿æ‹©æ—¶å‡€å€¼(å³)')
l3, = plt.plot(p14['åŸå§‹å‡€å€¼'],color='royalblue',label='åŸå§‹å‡€å€¼(å³)')
plt.xlim([p14['è¶…é¢'].dropna().index[0],p14['è¶…é¢'].dropna().index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2004+j,2,27) for j in range(20)])
plt.ylim([0,9])
# # å›¾ä¾‹åˆå¹¶
g =[ l1,l2,l3 ]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.title('å›¾14:ç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾14ï¼šç¾å€ºå®é™…æ”¶ç›Šç‡å‡çº¿ä¿¡å·æ‹©æ—¶æ•ˆæœ.png',dpi=800)
#%%
# è¡¨14:ç¾å€ºå‡çº¿æŒ‡æ ‡ä¸åŒå‚æ•°å¤šç©ºæ•ˆæœ
name_list_au = ['çº¯å¤šå¤´','çº¯ç©ºå¤´','å¤šç©º']
t14 = pd.DataFrame()
for i in name_list_au:
    if i != 'å¤šç©º':
        N_list =[1,15,20,25]
    else:
        N_list =[15,20,25]
    for j in N_list:
        t14.loc['è°ƒä»“é¢‘ç‡',i+'_'+str(j)] = 'M'
        resize_list_au_temp,temp_df = signal_count_net_value_au(daily_return_df=p14[['TIPSæ”¶ç›Šç‡','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],N=j,name=i)
        t14.loc['ç´¯è®¡å‡€å€¼',i+'_'+str(j)] = Performance(temp_df[i+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
        t14.loc['åˆè®¡å‘¨æœŸ',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
        t14.loc['ä¿¡å·æ¬¡æ•°',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
        t14.loc['å¤šå¤´',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
        t14.loc['ç©ºå¤´',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
        t14.loc['èƒœç‡',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
        t14.loc['ç›ˆäºæ¯”',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
        t14.loc['æœŸæœ›',i+'_'+str(j)] = Statistic_data(resize_list_au_temp, temp_df[i+'å»ºä»“te'],temp_df[i+'æŒä»“æ¶¨è·Œå¹…']).expectation()
        t14.loc['å¹´åŒ–æ”¶ç›Š',i+'_'+str(j)] = Performance(temp_df[i+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
        t14.loc['æ³¢åŠ¨',i+'_'+str(j)] = Performance(temp_df[i+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
        t14.loc['å¤æ™®',i+'_'+str(j)] = Performance(temp_df[i+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
        t14.loc['æœ€å¤§å›æ’¤',i+'_'+str(j)] = Performance(temp_df[i+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t14.rename(columns={'çº¯å¤šå¤´_1':'çº¯å¤šå¤´_åŸå§‹','çº¯ç©ºå¤´_1':'çº¯ç©ºå¤´_åŸå§‹'},inplace=True)
t14.to_excel(r'./output/è¡¨14ï¼šç¾å€ºå‡çº¿æŒ‡æ ‡ä¸åŒå‚æ•°å¤šç©ºæ•ˆæœ.xlsx')
#%%
"""
4.2.2 VIX ææ…ŒæŒ‡æ•°
    å›¾16:VIXæŒ‡æ ‡æ‹©æ—¶å‡€å€¼è¡¨ç°(2004.3.31-2023.8.30)
    è¡¨15ï¼šVIXæŒ‡æ ‡ä¸åŒå‚æ•°æ•ˆæœ(2004.3.31-2023.8.30)
"""
p16 = pd.concat([tips_vix['VIXæŒ‡æ•°'],au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],axis=1)
N = [10,15,20]
days_list = ['åŸå§‹']
for i in N :
    p16[str(i)+'å¤©æœ€å¤§'] = p16['VIXæŒ‡æ•°'].rolling(window=i).max()
    days_list.append(str(i)+'å¤©æœ€å¤§')
p16['20å¤©å‡å€¼'] = p16['VIXæŒ‡æ•°'].rolling(window=20).mean()
days_list.append('20å¤©å‡å€¼')
p16 = p16.loc['2004-3-31':,:]
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p16['date'] = p16.index
p16['yyyymm'] = p16.index.strftime('%Y-%m')
resize_list_vix = p16['date'].groupby(p16['yyyymm']).last()
# åˆ›å»ºt15ç”¨äºå­˜æ”¾æ•°æ®â€”â€”è¡¨15:VIXæŒ‡æ ‡ä¸åŒå‚æ•°æ•ˆæœ
t15 = pd.DataFrame()
for i in days_list:
    if i != 'åŸå§‹':
        condition = p16[i] > 20
        p16.loc[condition,i+'signal'] = 1
        for j in resize_list_vix:
            if p16.loc[j,i+'signal'] == 1:
                p16.loc[j,i+'å»ºä»“te'] = 1
            else:
                p16.loc[j,i+'å»ºä»“te'] = 0
    else:
        for j in resize_list_vix:
            p16.loc[j,i+'å»ºä»“te'] = 1
    p16[i+'å»ºä»“'] = p16[i+'å»ºä»“te'].shift(1)
    p16[i+'å»ºä»“'] = p16[i+'å»ºä»“'].fillna(method='ffill')
    condition = p16[i+'å»ºä»“'] == 1
    p16.loc[condition,i+'æŒä»“'] = 1
    p16[i+'æŒä»“æ¶¨è·Œå¹…'] = p16[i+'æŒä»“'] * p16['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']
    p16[i+'æŒä»“å‡€å€¼'] = (1 + p16[i+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
    p16[i+'æŒä»“å‡€å€¼'] = p16[i+'æŒä»“å‡€å€¼'].fillna(method='ffill')
    t15.loc['è°ƒä»“é¢‘ç‡',i] = 'M'
    t15.loc['ç´¯è®¡å‡€å€¼',i] = Performance(p16[i+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
    t15.loc['åˆè®¡å‘¨æœŸ',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
    t15.loc['ä¿¡å·æ¬¡æ•°',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
    t15.loc['å¤šå¤´',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
    t15.loc['ç©ºå¤´',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
    t15.loc['èƒœç‡',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
    t15.loc['ç›ˆäºæ¯”',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
    t15.loc['æœŸæœ›',i] = Statistic_data(resize_list_vix, p16[i+'å»ºä»“te'],p16[i+'æŒä»“æ¶¨è·Œå¹…']).expectation()
    t15.loc['å¹´åŒ–æ”¶ç›Š',i] = Performance(p16[i+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
    t15.loc['æ³¢åŠ¨',i] = Performance(p16[i+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
    t15.loc['å¤æ™®',i] = Performance(p16[i+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
    t15.loc['æœ€å¤§å›æ’¤',i] = Performance(p16[i+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t15.to_excel(r'./output/è¡¨15ï¼šVIXæŒ‡æ ‡ä¸åŒå‚æ•°æ•ˆæœ.xlsx')
#%%
p16.loc['2004-3-31','15å¤©æœ€å¤§æŒä»“å‡€å€¼'] = 1
# å¯è§†åŒ–â€”â€”â€”â€”å›¾16:VIXæŒ‡æ ‡æ‹©æ—¶å‡€å€¼è¡¨ç°
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
plt.plot(p16['åŸå§‹æŒä»“å‡€å€¼'],color='blue',label='åŸå§‹å‡€å€¼')
plt.plot(p16['15å¤©æœ€å¤§æŒä»“å‡€å€¼'],color='gold',label='vixæŒ‡æ ‡æ‹©æ—¶å‡€å€¼')
plt.xlim([p16['15å¤©æœ€å¤§æŒä»“å‡€å€¼'].dropna().index[0],p16['15å¤©æœ€å¤§æŒä»“å‡€å€¼'].dropna().index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2004+j,3,31) for j in range(20)])
plt.legend(fontsize=9)
plt.title('å›¾16:VIXæŒ‡æ ‡æ‹©æ—¶å‡€å€¼è¡¨ç°')
plt.tight_layout()
plt.show()
plt.savefig('./output/å›¾16ï¼šVIXæŒ‡æ ‡æ‹©æ—¶å‡€å€¼è¡¨ç°.png',dpi=800)
#%%
"""
4.2.3é»„é‡‘ä»·æ ¼åŠ¨é‡ .26 
    å›¾18:é»„é‡‘ä»·æ ¼250æ—¥åŠ¨é‡æŒ‡æ ‡å‡€å€¼æ›²çº¿(2005.1.31-2023.8.30)
    è¡¨16:é»„é‡‘ä»·æ ¼åŠ¨é‡ä¸åŒå‚æ•°å›æµ‹æƒ…å†µ(2005.1.31-2023.8.30)
"""
p18 = au9999[['Au','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']]
N = [20,60,250]
days_list = ['åŸå§‹']
for i in N :
    p18[str(i)+'æ—¥åŠ¨é‡'] = p18['Au'] / p18['Au'].shift(i) - 1
    days_list.append(str(i)+'æ—¥åŠ¨é‡')
p18 = p18.loc['2005-1-31':,:]
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p18['date'] = p18.index
p18['yyyymm'] = p18.index.strftime('%Y-%m')
resize_list_mmtum = p18['date'].groupby(p18['yyyymm']).last()
# åˆ›å»ºt16ç”¨äºå­˜æ”¾æ•°æ®â€”â€”è¡¨16:é»„é‡‘ä»·æ ¼åŠ¨é‡ä¸åŒå‚æ•°å›æµ‹æƒ…å†µ
t16 = pd.DataFrame()
direction =['å¤šå¤´','ç©ºå¤´']
# å¤šå¤´
for d in direction:
    if d == 'å¤šå¤´':
        for i in days_list:
            if i != 'åŸå§‹':
                condition = p18[i] > 0
                p18.loc[condition,d+i+'signal'] = 1
                for j in resize_list_mmtum:
                    if p18.loc[j,d+i+'signal'] == 1:
                        p18.loc[j,d+i+'å»ºä»“te'] = 1
                    else:
                        p18.loc[j,d+i+'å»ºä»“te'] = 0
            else:
                for j in resize_list_mmtum:
                    p18.loc[j,d+i+'å»ºä»“te'] = 1
            p18[d+i+'å»ºä»“'] = p18[d+i+'å»ºä»“te'].shift(1)
            p18[d+i+'å»ºä»“'] = p18[d+i+'å»ºä»“'].fillna(method='ffill')
            condition1 = p18[d+i+'å»ºä»“'] == 1
            p18.loc[condition1,d+i+'æŒä»“'] = 1
            p18[d+i+'æŒä»“æ¶¨è·Œå¹…'] = p18[d+i+'æŒä»“'] * p18['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']
            p18[d+i+'æŒä»“å‡€å€¼'] = (1 + p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
            p18[d+i+'æŒä»“å‡€å€¼'] = p18[d+i+'æŒä»“å‡€å€¼'].fillna(method='ffill')
            t16.loc['è°ƒä»“é¢‘ç‡',d+i] = 'M'
            t16.loc['ç´¯è®¡å‡€å€¼',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
            t16.loc['åˆè®¡å‘¨æœŸ',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
            t16.loc['ä¿¡å·æ¬¡æ•°',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
            t16.loc['å¤šå¤´',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
            t16.loc['ç©ºå¤´',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
            t16.loc['èƒœç‡',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
            t16.loc['ç›ˆäºæ¯”',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
            t16.loc['æœŸæœ›',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).expectation()
            t16.loc['å¹´åŒ–æ”¶ç›Š',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
            t16.loc['æ³¢åŠ¨',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
            t16.loc['å¤æ™®',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
            t16.loc['æœ€å¤§å›æ’¤',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
    elif d == 'ç©ºå¤´':
        for i in days_list:
            if i != 'åŸå§‹':
                condition = p18[i] < 0
                p18.loc[condition,d+i+'signal'] = -1
                for j in resize_list_mmtum:
                    if p18.loc[j,d+i+'signal'] == -1:
                        p18.loc[j,d+i+'å»ºä»“te'] = -1
                    else:
                        p18.loc[j,d+i+'å»ºä»“te'] = 0
            else:
                for j in resize_list_mmtum:
                    p18.loc[j,d+i+'å»ºä»“te'] = -1        
            p18[d+i+'å»ºä»“'] = p18[d+i+'å»ºä»“te'].shift(1)
            p18[d+i+'å»ºä»“'] = p18[d+i+'å»ºä»“'].fillna(method='ffill')
            condition2 = p18[d+i+'å»ºä»“'] == -1
            p18.loc[condition2,d+i+'æŒä»“'] = -1
            p18[d+i+'æŒä»“æ¶¨è·Œå¹…'] = p18[d+i+'æŒä»“'] * p18['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']
            p18[d+i+'æŒä»“å‡€å€¼'] = (1 + p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
            p18[d+i+'æŒä»“å‡€å€¼'] = p18[d+i+'æŒä»“å‡€å€¼'].fillna(method='ffill')
            t16.loc['è°ƒä»“é¢‘ç‡',d+i] = 'M'
            t16.loc['ç´¯è®¡å‡€å€¼',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
            t16.loc['åˆè®¡å‘¨æœŸ',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
            t16.loc['ä¿¡å·æ¬¡æ•°',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
            t16.loc['å¤šå¤´',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
            t16.loc['ç©ºå¤´',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
            t16.loc['èƒœç‡',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
            t16.loc['ç›ˆäºæ¯”',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
            t16.loc['æœŸæœ›',d+i] = Statistic_data(resize_list_mmtum, p18[d+i+'å»ºä»“te'],p18[d+i+'æŒä»“æ¶¨è·Œå¹…']).expectation()
            t16.loc['å¹´åŒ–æ”¶ç›Š',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
            t16.loc['æ³¢åŠ¨',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
            t16.loc['å¤æ™®',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
            t16.loc['æœ€å¤§å›æ’¤',d+i] = Performance(p18[d+i+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t16.to_excel(r'./output/è¡¨16ï¼šé»„é‡‘ä»·æ ¼åŠ¨é‡ä¸åŒå‚æ•°å›æµ‹æƒ…å†µ.xlsx')
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾18:é»„é‡‘ä»·æ ¼250æ—¥åŠ¨é‡æŒ‡æ ‡å‡€å€¼æ›²çº¿
p18.loc['2005-1-31',['å¤šå¤´åŸå§‹æŒä»“å‡€å€¼','å¤šå¤´250æ—¥åŠ¨é‡æŒä»“å‡€å€¼']] = 1
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
plt.plot(p18['å¤šå¤´åŸå§‹æŒä»“å‡€å€¼'],color='blue',label='åŸå§‹å‡€å€¼')
plt.plot(p18['å¤šå¤´250æ—¥åŠ¨é‡æŒä»“å‡€å€¼'],color='gold',label='é»„é‡‘åŠ¨é‡æ‹©æ—¶å‡€å€¼')
plt.xlim([p18['å¤šå¤´250æ—¥åŠ¨é‡æŒä»“å‡€å€¼'].dropna().index[0],p18['å¤šå¤´250æ—¥åŠ¨é‡æŒä»“å‡€å€¼'].dropna().index[-1]]) 
plt.ylim([0,4.5])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2005+j,1,31) for j in range(19)])
plt.legend(fontsize=9)
plt.title('å›¾18:é»„é‡‘ä»·æ ¼250æ—¥åŠ¨é‡æŒ‡æ ‡å‡€å€¼æ›²çº¿')
plt.tight_layout()
# plt.show()
plt.savefig('./output/å›¾18ï¼šé»„é‡‘ä»·æ ¼250æ—¥åŠ¨é‡æŒ‡æ ‡å‡€å€¼æ›²çº¿.png',dpi=800)
#%%
"""
4.2.4 åˆæˆä¿¡å· ..........................28 
    å›¾20:é»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶å‡€å€¼(2004.11.30-2023.8.30)
    è¡¨17:é»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶è¡¨ç°(2004.11.30-2023.8.30)
    å›¾21:é»„é‡‘æ‹©æ—¶æŒ‡æ ‡å›æ’¤(2004.11.30-2023.8.30)
"""
# ç¾å€ºå‡çº¿MAã€20ã€‘+VIXã€15å¤©ï¼ŒMAXã€‘+é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘
p20 = pd.concat([tips_vix,au9999[['Au','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']]],axis=1)
p20['ç¾å€ºå‡çº¿MAã€20ã€‘'] = p20['TIPSæ”¶ç›Šç‡'].rolling(window=20).mean()
p20['VIXã€15å¤©ï¼ŒMAXã€‘'] = p20['VIXæŒ‡æ•°'].rolling(window=15).max()
p20['é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘'] = p20['Au'] / p18['Au'].shift(250) - 1
# åŠ ä»“ä¿¡å·(1)
condition1 = p20['TIPSæ”¶ç›Šç‡'] < p20['ç¾å€ºå‡çº¿MAã€20ã€‘']
condition2 = p20['VIXã€15å¤©ï¼ŒMAXã€‘'] > 20
condition3 = p20['é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘'] > 0
# å‡ä»“ä¿¡å·(-1)
condition4 = p20['TIPSæ”¶ç›Šç‡'] > p20['ç¾å€ºå‡çº¿MAã€20ã€‘']
# å»ºç«‹ä¿¡å·
p20.loc[condition1,'ç¾å€ºå‡çº¿MAã€20ã€‘signal' ] = 1
p20.loc[condition2,'VIXã€15å¤©ï¼ŒMAXã€‘signal'] = 1
p20.loc[condition3,'é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘signal'] = 1
p20.loc[condition4,'ç¾å€ºå‡çº¿MAã€20ã€‘signal' ] = -1
combine_list = ['ç¾å€ºå‡çº¿MAã€20ã€‘','VIXã€15å¤©ï¼ŒMAXã€‘','é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘']
p20['åˆæˆsignal'] = 0
for i in combine_list:
    p20[i+'signal'] = p20[i+'signal'].fillna(value=0)
    p20['åˆæˆsignal'] += p20[i+'signal']
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p20['date'] = p20.index
p20['yyyymm'] = p20.index.strftime('%Y-%m')
resize_list_combine = p20['date'].groupby(p20['yyyymm']).last()
for i in resize_list_combine :
    if p20.loc[i,'åˆæˆsignal'] >= 2:
        p20.loc[i,'åˆæˆä¿¡å·å¤šå¤´å»ºä»“te'] = 1
        p20.loc[i,'åˆæˆä¿¡å·å¤šç©ºå»ºä»“te'] = 1
    elif p20.loc[i,'åˆæˆsignal'] < 0:
        p20.loc[i,'åˆæˆä¿¡å·å¤šç©ºå»ºä»“te'] = -1
    else:
        p20.loc[i,'åˆæˆä¿¡å·å¤šå¤´å»ºä»“te'] = 0
        p20.loc[i,'åˆæˆä¿¡å·å¤šç©ºå»ºä»“te'] = 0
for j in resize_list_combine:
    p20.loc[j,'åŸå§‹å»ºä»“te'] = 1
p20 = p20.loc['2004-11-30':,:]
direction = ['åŸå§‹','åˆæˆä¿¡å·å¤šå¤´','åˆæˆä¿¡å·å¤šç©º']
# åˆ›å»ºt17ç”¨äºå­˜æ”¾æ•°æ®â€”â€”è¡¨17:é»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶è¡¨ç°
t17 = pd.DataFrame()
for i in direction:
    p20[i+'å»ºä»“'] = p20[i+'å»ºä»“te'].shift(1)
    p20[i+'å»ºä»“'] = p20[i+'å»ºä»“'].fillna(method='ffill')
    condition1 = p20[i+'å»ºä»“'] == 1
    condition2 = p20[i+'å»ºä»“'] == -1
    p20.loc[condition1,i+'æŒä»“'] = 1 
    p20.loc[condition2,i+'æŒä»“'] = -1 
    p20[i+'æŒä»“æ¶¨è·Œå¹…'] = p20[i+'æŒä»“'] * p20['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…'] * (1+0.1)
    p20[i+'æŒä»“å‡€å€¼'] = (1 + p20[i+'æŒä»“æ¶¨è·Œå¹…']).cumprod()
    p20[i+'æŒä»“å‡€å€¼'] = p20[i+'æŒä»“å‡€å€¼'].fillna(method='ffill')
    t17.loc['è°ƒä»“é¢‘ç‡',i] = 'M'
    t17.loc['ç´¯è®¡å‡€å€¼',i] = Performance(p20[i+'æŒä»“å‡€å€¼'].dropna()).accumulate_net_value()
    t17.loc['åˆè®¡å‘¨æœŸ',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).sum_period()
    t17.loc['ä¿¡å·æ¬¡æ•°',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).sum_signal()
    t17.loc['å¤šå¤´',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).sum_long_signal()
    t17.loc['ç©ºå¤´',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).sum_short_signal()
    t17.loc['èƒœç‡',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).win_rate()
    t17.loc['ç›ˆäºæ¯”',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).profi_loss_ratio()
    t17.loc['æœŸæœ›',i] = Statistic_data(resize_list_combine, p20[i+'å»ºä»“te'],p20[i+'æŒä»“æ¶¨è·Œå¹…']).expectation()
    t17.loc['å¹´åŒ–æ”¶ç›Š',i] = Performance(p20[i+'æŒä»“å‡€å€¼'].dropna()).annualized_returns 
    t17.loc['æ³¢åŠ¨',i] = Performance(p20[i+'æŒä»“å‡€å€¼'].dropna()).annualized_volatility
    t17.loc['å¤æ™®',i] = Performance(p20[i+'æŒä»“å‡€å€¼'].dropna()).cal_sharp()
    t17.loc['æœ€å¤§å›æ’¤',i] = Performance(p20[i+'æŒä»“å‡€å€¼'].dropna()).max_drawdown()
t17.to_excel(r'./output/è¡¨17ï¼šé»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶è¡¨ç°.xlsx')
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾20:é»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶å‡€å€¼
p20.loc['2004-11-30',['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼','åŸå§‹æŒä»“å‡€å€¼']] = 1
p20['è¶…é¢'] = p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼'] - p20['åŸå§‹æŒä»“å‡€å€¼']
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
l1 = ax1.fill_between(p20['è¶…é¢'].index,p20['è¶…é¢'],label='è¶…é¢',color = 'orange',interpolate=True,alpha=0.7)
plt.ylim([-2,6])
# plt.yticks([-2,-1,0,1,2,3,4,5,6])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼'],color='royalblue',label='ç­–ç•¥å‡€å€¼(åˆæˆæŒ‡æ ‡)(å³)',lw=2.5)
l3, = plt.plot(p20['åŸå§‹æŒä»“å‡€å€¼'],color='darkblue',label='åŸå§‹å‡€å€¼(å³)',lw=2.5)
plt.xlim([p20['è¶…é¢'].dropna().index[0],p20['è¶…é¢'].dropna().index[-1]]) 
plt.ylim([1,10])
# plt.yticks([1,2,3,4,5,6,7,8,9,10])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2004+j,11,30) for j in range(19)])
# # å›¾ä¾‹åˆå¹¶
g =[ l1,l2,l3 ]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.title('å›¾20:é»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶å‡€å€¼')
plt.tight_layout()
plt.savefig('./output/å›¾20ï¼šé»„é‡‘åˆæˆæŒ‡æ ‡æ‹©æ—¶å‡€å€¼.png',dpi=800)
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾21:é»„é‡‘æ‹©æ—¶æŒ‡æ ‡å›æ’¤
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
ax1.spines['bottom'].set_visible(False)
plt.plot(drawdown(p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼'].dropna()),color='gold',label='ç­–ç•¥å›æ’¤',lw=2.5)
plt.plot(drawdown(p20['åŸå§‹æŒä»“å‡€å€¼'].dropna()),color='royalblue',label='åŸå§‹å›æ’¤',lw=2.5)
plt.axhline(y=0, color='black', linestyle='-', linewidth=1)
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2004+j,11,30) for j in range(19)])
plt.xlim([p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼'].dropna().index[0],p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“å‡€å€¼'].dropna().index[-1]]) 
plt.title('å›¾21:é»„é‡‘æ‹©æ—¶æŒ‡æ ‡å›æ’¤')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾21ï¼šé»„é‡‘æ‹©æ—¶æŒ‡æ ‡å›æ’¤.png',dpi=800)
#%%
"""
5.æˆ˜ç•¥+æˆ˜æœ¯.. 29 
5.1 é£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶...... 30 
    è¡¨18ï¼šé£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶æŒ‡æ ‡ä¸šç»©è¡¨ç°(2012.12.31-2023.8.30)
    å›¾23:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å‡€å€¼(2012.12.31-2023.8.30)
    å›¾24:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å›æ’¤(2012.12.31-2023.8.30)
"""
p23 = pd.concat([p5_w,p10[['ä¿¡å·ç»“åˆæŒä»“']],net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'],net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']],axis=1)
p23[['ä¸­è¯800','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°']] = p23[['ä¸­è¯800','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°']].fillna(method='ffill')
p23['ä¿¡å·ç»“åˆæŒä»“'] = p23['ä¿¡å·ç»“åˆæŒä»“'].fillna(value=0)
# è‚¡å€ºæ‹©æ—¶æƒé‡
condition1 = p23['ä¿¡å·ç»“åˆæŒä»“'] == 1
condition2 = p23['ä¿¡å·ç»“åˆæŒä»“'] == -1
condition3 = p23['ä¿¡å·ç»“åˆæŒä»“'] == 0
p23.loc[condition1,'ä¸­è¯800_æ‹©æ—¶'] = 0.3
p23.loc[condition2,'ä¸­è¯800_æ‹©æ—¶'] = 0
p23.loc[condition3,'ä¸­è¯800_æ‹©æ—¶'] = p23.loc[condition3,'ä¸­è¯800'] 
p23['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°_æ‹©æ—¶'] = 1 - p23['ä¸­è¯800_æ‹©æ—¶'] 
p23 = p23.dropna()
# è®¡ç®—å‡€å€¼
p23['é£é™©é¢„ç®—'] =  p23['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p23['ä¸­è¯800']  + p23['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']*p23['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°']
p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶'] = p23['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p23['ä¸­è¯800_æ‹©æ—¶']  + p23['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']*p23['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°_æ‹©æ—¶']
p23['é£é™©é¢„ç®—_å‡€å€¼'] = (1+p23['é£é™©é¢„ç®—']).cumprod()
p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'] = (1+p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶']).cumprod()
p23.loc['2012-12-31',['é£é™©é¢„ç®—_å‡€å€¼','é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']] = 1
p23 = p23.sort_index()
p23['è¶…é¢'] = p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'] - p23['é£é™©é¢„ç®—_å‡€å€¼']
# å¯è§†åŒ–â€”â€”â€”â€”å›¾23:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å‡€å€¼
fig, ax1 = plt.subplots(figsize=(8,4))
ax1.spines['top'].set_visible(False)
l1 = plt.fill_between(p23.index,p23['è¶…é¢'],color = '#FFD306',label='è¶…é¢')
plt.xticks(rotation=30)
plt.xlim([p23['è¶…é¢'].dropna().index[0],p23['è¶…é¢'].dropna().index[-1]])  # è®¾ç½®xè½´åˆ»åº¦èŒƒå›´
plt.ylim([-0.05,0.35])
plt.axis('tight')
ax2 = plt.twinx()
ax2.spines['top'].set_visible(False)
l2, = plt.plot(p23['é£é™©é¢„ç®—_å‡€å€¼'], color='midnightblue',label='é£é™©é¢„ç®—(å³)',lw=2.5) 
l3, = plt.plot(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'], color='royalblue',label='é£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶(å³)',lw=2.5) 
plt.xlim([p23['è¶…é¢'].dropna().index[0],p23['è¶…é¢'].dropna().index[-1]]) 
plt.ylim([0.8,2.4])
plt.yticks([0.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾23:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å‡€å€¼')
# å›¾ä¾‹åˆå¹¶
g = [l1, l2, l3]
f = [l.get_label() for l in g]
plt.legend(g,f,fontsize=9)
plt.tight_layout()
plt.savefig('./output/å›¾23ï¼šåŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å‡€å€¼.png',dpi=800)
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾24:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å›æ’¤
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
ax1.spines['bottom'].set_visible(False)
plt.plot(drawdown(p23['é£é™©é¢„ç®—_å‡€å€¼'].dropna()),color='royalblue',lw=2.5,label='é£é™©é¢„ç®—')
plt.plot(drawdown(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'].dropna()),color='gold',lw=2.5,label='é£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶')
plt.axhline(y=0, color='black', linestyle='-', linewidth=0.9)
plt.xlim([p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'].dropna().index[0],p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼'].dropna().index[-1]]) 
plt.ylim([-0.12,0])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾24:åŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å›æ’¤')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾24ï¼šåŠ å…¥è‚¡å€ºæ‹©æ—¶çš„å›æ’¤.png',dpi=800)
#%%
t18 = pd.DataFrame()
# è¡¨18ï¼šé£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶æŒ‡æ ‡ä¸šç»©è¡¨ç°
t18_net = p23[['é£é™©é¢„ç®—_å‡€å€¼','é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']]
t18_net['year'] = t18_net.index.year
y_s = t18_net.index[-1].year - t18_net.index[0].year 
start_year = 2013
for i in range(y_s):
    temp_1 = t18_net[ t18_net['year'] ==  start_year]
    # é£é™©é¢„ç®—_å‡€å€¼ä¸šç»©è¡¨ç°
    t18.loc[start_year,'æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).annualized_returns
    t18.loc[start_year,'æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).annualized_volatility
    t18.loc[start_year,'å¤æ™®_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).cal_sharp()
    t18.loc[start_year,'æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).max_drawdown()
    t18.loc[start_year,'å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).cal_calmar()
    # æ‹©æ—¶åŠ ä»“30%ä¸šç»©è¡¨ç°
    t18.loc[start_year,'æ”¶ç›Šç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(temp_1['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).annualized_returns
    t18.loc[start_year,'æ³¢åŠ¨ç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(temp_1['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).annualized_volatility
    t18.loc[start_year,'å¤æ™®_æ‹©æ—¶åŠ ä»“30%'] = Performance(temp_1['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).cal_sharp()
    t18.loc[start_year,'æœ€å¤§å›æ’¤_æ‹©æ—¶åŠ ä»“30%'] = Performance(temp_1['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).max_drawdown()
    t18.loc[start_year,'å¡ç›æ¯”ç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(temp_1['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).cal_calmar()    
    start_year += 1

t18.loc['åŒºé—´','æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(p23['é£é™©é¢„ç®—_å‡€å€¼']).annualized_returns
t18.loc['åŒºé—´','æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(p23['é£é™©é¢„ç®—_å‡€å€¼']).annualized_volatility
t18.loc['åŒºé—´','å¤æ™®_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(p23['é£é™©é¢„ç®—_å‡€å€¼']).cal_sharp()
t18.loc['åŒºé—´','æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(p23['é£é™©é¢„ç®—_å‡€å€¼']).max_drawdown()
t18.loc['åŒºé—´','å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€º98/2'] = Performance(p23['é£é™©é¢„ç®—_å‡€å€¼']).cal_calmar()

t18.loc['åŒºé—´','æ”¶ç›Šç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).annualized_returns
t18.loc['åŒºé—´','æ³¢åŠ¨ç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).annualized_volatility
t18.loc['åŒºé—´','å¤æ™®_æ‹©æ—¶åŠ ä»“30%'] = Performance(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).cal_sharp()
t18.loc['åŒºé—´','æœ€å¤§å›æ’¤_æ‹©æ—¶åŠ ä»“30%'] = Performance(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).max_drawdown()
t18.loc['åŒºé—´','å¡ç›æ¯”ç‡_æ‹©æ—¶åŠ ä»“30%'] = Performance(p23['é£é™©é¢„ç®—_è‚¡å€ºæ‹©æ—¶_å‡€å€¼']).cal_calmar()

t18['ç›¸å¯¹è¶…é¢'] = t18['æ”¶ç›Šç‡_æ‹©æ—¶åŠ ä»“30%'] - t18['æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€º98/2']
t18.to_excel(r'./output/è¡¨18ï¼šé£é™©é¢„ç®—+è‚¡å€ºæ‹©æ—¶æŒ‡æ ‡ä¸šç»©è¡¨ç°.xlsx')
#%%
"""
5.2 é£é™©é¢„ç®—+é»„é‡‘æ‹©æ—¶... 32 
    è¡¨20:1%é£é™©é¢„ç®—åˆ†é…ç»™é»„é‡‘ï¼Œç»„åˆæ³¢åŠ¨ç‡ä¸‹é™æ˜æ˜¾(2012.12.31-2023.8.30)
    è¡¨21:åŠ å…¥é»„é‡‘æ‹©æ—¶ï¼Œç»„åˆæ³¢åŠ¨è¿›ä¸€æ­¥ä¸‹é™ï¼Œæ”¶ç›Šæœ‰æ‰€æå‡(2012.12.31-2023.8.30)
    å›¾27:é»„é‡‘æ‹©æ—¶é™ä½æ³¢åŠ¨å¹³æ»‘æ”¶ç›Š(2012.12.31-2023.8.30)
    å›¾28:é»„é‡‘æ‹©æ—¶å›æ’¤(2012.12.31-2023.8.30)
"""
# æ–‡ä¸­æ²¡æœ‰æåŠï¼Œåœ¨æŒæœ‰è‚¡å€ºé‡‘ä¸‰ç§èµ„äº§ï¼ŒåŒæ—¶é™åˆ¶è‚¡ç¥¨ä»“ä½ä¸º30%åï¼Œå‰©ä¸‹çš„ä»“ä½æ€ä¹ˆåˆ†é…ã€‚
p27 = pd.concat([net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'],net_value_bond['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'],net_value_au9999['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],axis=1)
# å›æµ‹æœˆæ•°m_s
m_s = get_last_day(2012,2023) # è·å–æ—¶é—´èŒƒå›´å†…æ¯ä¸ªæœˆçš„æœ€åä¸€å¤©å¹¶æ ¼å¼åŒ–æˆ'yyyy-mm-dd'çš„datetimeæ ¼å¼
m_s = m_s[11:-1] # å»æ‰å›æµ‹æœŸä»¥å¤–çš„æ—¶é—´èŒƒå›´ã€‚âš ï¸æ¯æ¬¡è°ƒæ•´å›æµ‹æœŸè¿™é‡Œéƒ½éœ€è¦ä¿®æ”¹ï¼ï¼
p27_w = pd.DataFrame() # p5_wå­˜å‚¨é£é™©é¢„ç®—åˆ†é…è‚¡å€ºæƒé‡
for i in m_s:
    i_rets = p27.loc[:i,:][-60:]*100
    cov = np.array(i_rets.cov())
    w = risk_budgeting(cov,b=np.array([0.97,0.02,0.01]))
    if w[0] > 0.3:
        w[0] = 0.3 # é™åˆ¶é£é™©èµ„äº§ï¼ˆè‚¡ç¥¨ï¼‰ä»“ä½<=30%
        # ç©ºå‡ºçš„ä»“ä½æ”¾åœ¨é»„é‡‘ä¸Š
        w[2] = 1 - w[0] - w[1]
    if w[2] > 0.1:
        w[2] = 0.1
    p27_w.loc[i,'ä¸­è¯800æƒé‡'] = w[0]
    p27_w.loc[i,'ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡'] = 1 - w[0] - w[2]
    p27_w.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡'] = w[2]
p27 = pd.concat([p27,p27_w,p20['åˆæˆä¿¡å·å¤šç©ºæŒä»“']],axis=1)
p27[['ä¸­è¯800æƒé‡','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡','ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']] = p27[['ä¸­è¯800æƒé‡','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡','ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']].fillna(method='ffill')
p27['åˆæˆä¿¡å·å¤šç©ºæŒä»“'] = p27['åˆæˆä¿¡å·å¤šç©ºæŒä»“'].fillna(value=0)
# é‡‘æ‹©æ—¶æƒé‡
condition1 = p27['åˆæˆä¿¡å·å¤šç©ºæŒä»“'] == 1
condition2 = p27['åˆæˆä¿¡å·å¤šç©ºæŒä»“'] == -1
condition3 = p27['åˆæˆä¿¡å·å¤šç©ºæŒä»“'] == 0
p27.loc[condition1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p27.loc[condition1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']+0.05#    *(1+0.05)
p27.loc[condition2,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p27.loc[condition2,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']-0.05 #   *(1-0.05)
p27.loc[condition3,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p27.loc[condition3,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']
for i in p27.index:
    if p27.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] > 0.1:
        p27.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = 0.1
    elif p27.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] < 0:
        p27.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = 0
p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶'] = p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡']
p27['ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 1 - p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶'] - p27['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']
for i in p27.index:
    if p27.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] > 0.3:
        p27.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 0.3  
p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶'] = 1 - p27['ä¸­è¯800æƒé‡_æ‹©æ—¶'] - p27['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']
p27 = p27.dropna()
p27['é£é™©é¢„ç®—'] =  p27['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸­è¯800æƒé‡']  + p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡'] + p27['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']
p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶'] = p27['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸­è¯800æƒé‡_æ‹©æ—¶']  + p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶']+ p27['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']*p27['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']
p27['é£é™©é¢„ç®—_å‡€å€¼'] = 1+p27['é£é™©é¢„ç®—']
p27.loc['2012-12-31','é£é™©é¢„ç®—_å‡€å€¼'] = 1
p27['é£é™©é¢„ç®—_å‡€å€¼'] = p27['é£é™©é¢„ç®—_å‡€å€¼'].cumprod()
p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'] = 1+p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶']
p27.loc['2012-12-31','é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'] = 1
p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'] = p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].cumprod()
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾27:é»„é‡‘æ‹©æ—¶é™ä½æ³¢åŠ¨å¹³æ»‘æ”¶ç›Š
fig, ax1 = plt.subplots(figsize=(8,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
plt.plot(p27['é£é™©é¢„ç®—_å‡€å€¼'], color='midnightblue',label='é£é™©é¢„ç®—',lw=2.5) 
plt.plot(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'], color='gold',label='é£é™©é¢„ç®—+é»„é‡‘æ‹©æ—¶',lw=2.5) 
plt.xlim([p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].dropna().index[0],p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].dropna().index[-1]]) 
plt.ylim([0.8,2])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾27:é»„é‡‘æ‹©æ—¶é™ä½æ³¢åŠ¨å¹³æ»‘æ”¶ç›Š')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾27ï¼šé»„é‡‘æ‹©æ—¶é™ä½æ³¢åŠ¨å¹³æ»‘æ”¶ç›Š.png',dpi=800)
#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾28:é»„é‡‘æ‹©æ—¶å›æ’¤
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
ax1.spines['bottom'].set_visible(False)
plt.plot(drawdown(p27['é£é™©é¢„ç®—_å‡€å€¼'].dropna()),color='royalblue',label='é£é™©é¢„ç®—',lw=2.5)
plt.plot(drawdown(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].dropna()),color='gold',label='é£é™©é¢„ç®—+é»„é‡‘æ‹©æ—¶',lw=2.5)
plt.axhline(y=0, color='black', linestyle='-', linewidth=1)
plt.xlim([p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].dropna().index[0],p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼'].dropna().index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾28:é»„é‡‘æ‹©æ—¶å›æ’¤')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾28ï¼šé»„é‡‘æ‹©æ—¶å›æ’¤.png',dpi=800)
#%%
# è¡¨20:1%é£é™©é¢„ç®—åˆ†é…ç»™é»„é‡‘ï¼Œç»„åˆæ³¢åŠ¨ç‡ä¸‹é™æ˜æ˜¾
""" æ³¢åŠ¨ç‡ä¸‹é™ä¸æ˜æ˜¾"""
t20 = t18.iloc[:,:5]
t20_net = p27[['é£é™©é¢„ç®—_å‡€å€¼','é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']]
t20_net['year'] = t20_net.index.year
y_s = t20_net.index[-1].year - t20_net.index[0].year 
start_year = 2013
for i in range(y_s):
    temp_1 = t20_net[ t20_net['year'] ==  start_year]
    # é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1ä¸šç»©è¡¨ç°
    t20.loc[start_year,'æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).annualized_returns
    t20.loc[start_year,'æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).annualized_volatility
    t20.loc[start_year,'å¤æ™®_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).cal_sharp()
    t20.loc[start_year,'æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).max_drawdown()
    t20.loc[start_year,'å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(temp_1['é£é™©é¢„ç®—_å‡€å€¼']).cal_calmar()    
    start_year += 1
t20.loc['åŒºé—´','æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(p27['é£é™©é¢„ç®—_å‡€å€¼']).annualized_returns
t20.loc['åŒºé—´','æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(p27['é£é™©é¢„ç®—_å‡€å€¼']).annualized_volatility
t20.loc['åŒºé—´','å¤æ™®_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(p27['é£é™©é¢„ç®—_å‡€å€¼']).cal_sharp()
t20.loc['åŒºé—´','æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(p27['é£é™©é¢„ç®—_å‡€å€¼']).max_drawdown()
t20.loc['åŒºé—´','å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] = Performance(p27['é£é™©é¢„ç®—_å‡€å€¼']).cal_calmar()
t20['æ³¢åŠ¨ç‡_ç›¸å¯¹å˜åŠ¨'] = t20['æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1'] - t20['æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€º98/2']
t20.to_excel(r'./output/è¡¨20ï¼š1%é£é™©é¢„ç®—åˆ†é…ç»™é»„é‡‘ï¼Œç»„åˆæ³¢åŠ¨ç‡ä¸‹é™æ˜æ˜¾.xlsx')
#%%
# è¡¨21:åŠ å…¥é»„é‡‘æ‹©æ—¶ï¼Œç»„åˆæ³¢åŠ¨è¿›ä¸€æ­¥ä¸‹é™ï¼Œæ”¶ç›Šæœ‰æ‰€æå‡
t21 =  t20.iloc[:,5:10] 
start_year = 2013
for  i in range(y_s):
    temp_1 = t20_net.loc[ t20_net['year'] ==  start_year,:]
    # é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1ä¸šç»©è¡¨ç°
    t21.loc[start_year,'æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(temp_1['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).annualized_returns
    t21.loc[start_year,'æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(temp_1['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).annualized_volatility
    t21.loc[start_year,'å¤æ™®_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(temp_1['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).cal_sharp()
    t21.loc[start_year,'æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(temp_1['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).max_drawdown()
    t21.loc[start_year,'å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(temp_1['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).cal_calmar()    
    start_year += 1

t21.loc['åŒºé—´','æ”¶ç›Šç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).annualized_returns
t21.loc['åŒºé—´','æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).annualized_volatility
t21.loc['åŒºé—´','å¤æ™®_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).cal_sharp()
t21.loc['åŒºé—´','æœ€å¤§å›æ’¤_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).max_drawdown()
t21.loc['åŒºé—´','å¡ç›æ¯”ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] = Performance(p27['é£é™©é¢„ç®—_é»„é‡‘æ‹©æ—¶_å‡€å€¼']).cal_calmar()

t21['ç›¸å¯¹è¶…é¢'] = t21['æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1+é»„é‡‘æ‹©æ—¶'] - t21['æ³¢åŠ¨ç‡_é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1']
t21.to_excel(r'./output/è¡¨21ï¼šåŠ å…¥é»„é‡‘æ‹©æ—¶ï¼Œç»„åˆæ³¢åŠ¨è¿›ä¸€æ­¥ä¸‹é™ï¼Œæ”¶ç›Šæœ‰æ‰€æå‡.xlsx')
#%%
"""
5.3 é£é™©é¢„ç®—+è‚¡å€º+é»„é‡‘æ‹©æ—¶ 33 
    å›¾29:ç»„åˆå‡€å€¼(2012.12.31-2023.8.30)
    å›¾30:ç»„åˆå›æ’¤(2012.12.31-2023.8.30)
    è¡¨23ï¼šå›ºå®šæ¯”ä¾‹->é£é™©é¢„ç®—->åŠ å…¥æ‹©æ—¶çš„é£é™©é¢„ç®—ç»„åˆå¹´åº¦ä¸šç»©(2012.12.31-2023.8.30)
"""
p29 = pd.concat([net_value_800['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'],net_value_bond[['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']],net_value_au9999[['Au','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']],p27[['ä¸­è¯800æƒé‡','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡','ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']],p8[['åŠ æƒERP']],volume_800[['æˆäº¤é‡M='+str(M),'ä¸­è¯800æˆäº¤é‡']],p9[['close','MA_close']],tips_vix,p20[['ç¾å€ºå‡çº¿MAã€20ã€‘','VIXã€15å¤©ï¼ŒMAXã€‘','é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘']]],axis=1)
"""æ„å»ºä¿¡å·"""
# è‚¡å€ºæ‹©æ—¶
# åŠ æƒERPä¿¡å·
p29.loc[p29['åŠ æƒERP'] > up,'åŠ æƒERPä¿¡å·signal'] = 1
p29.loc[p29['åŠ æƒERP'] < down,'åŠ æƒERPä¿¡å·signal'] = -1
p29['åŠ æƒERPä¿¡å·signal'] = p29['åŠ æƒERPä¿¡å·signal'].fillna(value=0)
# é‡ä»·ä¿¡å·
p29.loc[(p29['close'] > p29['MA_close']) & (p29['ä¸­è¯800æˆäº¤é‡'] > p29['æˆäº¤é‡M='+str(M)]),'é‡ä»·ä¿¡å·signal'] = 1
p29.loc[p29['close'] < p29['MA_close'],'é‡ä»·ä¿¡å·signal'] = -1
p29['é‡ä»·ä¿¡å·signal'] = p29['é‡ä»·ä¿¡å·signal'].fillna(value=0) 
# ä¿¡å·ç»“åˆ
p29['è‚¡å€ºsignal'] = p29['åŠ æƒERPä¿¡å·signal'] + p29['é‡ä»·ä¿¡å·signal']
# é»„é‡‘æ‹©æ—¶
p29.loc[p29['TIPSæ”¶ç›Šç‡'] < p29['ç¾å€ºå‡çº¿MAã€20ã€‘'],'ç¾å€ºå‡çº¿MAã€20ã€‘signal' ] = 1
p29.loc[p29['TIPSæ”¶ç›Šç‡'] > p29['ç¾å€ºå‡çº¿MAã€20ã€‘'],'ç¾å€ºå‡çº¿MAã€20ã€‘signal' ] = -1
p29.loc[p29['VIXã€15å¤©ï¼ŒMAXã€‘'] > 20,'VIXã€15å¤©ï¼ŒMAXã€‘signal'] = 1
p29.loc[p29['é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘'] > 0,'é»„é‡‘ä»·æ ¼åŠ¨é‡ã€250ã€‘signal'] = 1
# ä¿¡å·ç»“åˆ
p29['é‡‘signal'] = 0
for i in combine_list:
    p29[i+'signal'] = p29[i+'signal'].fillna(value=0)
    p29['é‡‘signal'] += p29[i+'signal']
# æ‰¾å‡ºè°ƒä»“æ—¥â€”â€”æ¯æœˆæœ€åä¸€ä¸ªäº¤æ˜“æ—¥
p29['date']=p29.index
p29['yyyymm'] = p29.index.strftime('%Y-%m')
resize_list_tactics = p29['date'].groupby(p29['yyyymm']).last()
# å»ºä»“ä¿¡å·
for i in resize_list_tactics:
    # è‚¡å€ºï¼ˆå¤šç©ºï¼‰
    if p29.loc[i,'è‚¡å€ºsignal'] >= 2:
        p29.loc[i,'è‚¡å€ºå¤šç©ºå»ºä»“te'] = 1
    elif p29.loc[i,'è‚¡å€ºsignal'] <= -2:
        p29.loc[i,'è‚¡å€ºå¤šç©ºå»ºä»“te'] = -1
    else:
        p29.loc[i,'è‚¡å€ºå¤šç©ºå»ºä»“te'] = 0
    # é‡‘ï¼ˆå¤šç©º
    if p29.loc[i,'é‡‘signal'] >= 2:
        p29.loc[i,'é‡‘å¤šç©ºå»ºä»“te'] = 1
    elif p29.loc[i,'é‡‘signal'] < 0:
        p29.loc[i,'é‡‘å¤šç©ºå»ºä»“te'] = -1
    else:
        p29.loc[i,'é‡‘å¤šç©ºå»ºä»“te'] = 0
p29['è‚¡å€ºå¤šç©ºå»ºä»“'] = p29['è‚¡å€ºå¤šç©ºå»ºä»“te'].shift(1)
p29['é‡‘å¤šç©ºå»ºä»“'] = p29['é‡‘å¤šç©ºå»ºä»“te'].shift(1)
p29['è‚¡å€ºå¤šç©ºå»ºä»“']  = p29['è‚¡å€ºå¤šç©ºå»ºä»“'].fillna(method='ffill')
p29['é‡‘å¤šç©ºå»ºä»“'] = p29['é‡‘å¤šç©ºå»ºä»“'].fillna(method='ffill')
# æŒä»“
p29.loc[p29['è‚¡å€ºå¤šç©ºå»ºä»“']==1,'è‚¡å€ºå¤šç©ºæŒä»“'] = 1
p29.loc[p29['è‚¡å€ºå¤šç©ºå»ºä»“']==-1,'è‚¡å€ºå¤šç©ºæŒä»“'] = -1
p29.loc[p29['è‚¡å€ºå¤šç©ºå»ºä»“']==0,'è‚¡å€ºå¤šç©ºæŒä»“'] = 0
p29.loc[p29['é‡‘å¤šç©ºå»ºä»“']==1,'é‡‘å¤šç©ºæŒä»“'] = 1
p29.loc[p29['é‡‘å¤šç©ºå»ºä»“']==-1,'é‡‘å¤šç©ºæŒä»“'] = -1
p29.loc[p29['é‡‘å¤šç©ºå»ºä»“']==0,'é‡‘å¤šç©ºæŒä»“'] = 0
# è‚¡å€ºæ‹©æ—¶æƒé‡
p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==1,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 0.3#p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==0,'ä¸­è¯800æƒé‡']*(1+0.3)
p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==-1,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 0#p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==0,'ä¸­è¯800æƒé‡']*(1-0.3)
p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==0,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = p29.loc[p29['è‚¡å€ºå¤šç©ºæŒä»“']==0,'ä¸­è¯800æƒé‡']
# é‡‘æ‹©æ—¶æƒé‡
p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']+0.05
p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==-1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==-1,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']-0.05
p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==0,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = p29.loc[p29['é‡‘å¤šç©ºæŒä»“']==0,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']
for i in p29.index:
    if p29.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] > 0.3:
        p29.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 0.3
    if p29.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] < 0:
        p29.loc[i,'ä¸­è¯800æƒé‡_æ‹©æ—¶'] = 0
    if p29.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] > 0.1:
        p29.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = 0.1
    elif p29.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] < 0:
        p29.loc[i,'ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶'] = 0
p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶'] = 1 - p29['ä¸­è¯800æƒé‡_æ‹©æ—¶'] - p27['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']
p29 = p29[['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…','ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…','ä¸­è¯800æƒé‡','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡','ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡','ä¸­è¯800æƒé‡_æ‹©æ—¶','ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶','ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']]
p29 = p29.dropna()
# å‡€å€¼è®¡ç®—
p29['å›ºå®šæ¯”ä¾‹_æ¶¨è·Œå¹…'] =  p29['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…'] * 0.15  + p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'] * 0.8 + p29['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']* 0.05
p29['é£é™©é¢„ç®—_æ¶¨è·Œå¹…'] =  p29['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p29['ä¸­è¯800æƒé‡']  + p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…'] * p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡'] + p29['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']*p29['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡']
p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_æ¶¨è·Œå¹…'] = p29['ä¸­è¯800æ¯æ—¥æ¶¨è·Œå¹…']*p29['ä¸­è¯800æƒé‡_æ‹©æ—¶']  + p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æ¯æ—¥æ¶¨è·Œå¹…']*p29['ä¸­å€ºç»¼åˆæ€»è´¢å¯ŒæŒ‡æ•°æƒé‡_æ‹©æ—¶'] + p29['ä¸Šæµ·é»„é‡‘ç°è´§æ¯æ—¥æ¶¨è·Œå¹…']*p29['ä¸Šæµ·é»„é‡‘ç°è´§æƒé‡_æ‹©æ—¶']
p29['å›ºå®šæ¯”ä¾‹_å‡€å€¼'] = (1+p29['å›ºå®šæ¯”ä¾‹_æ¶¨è·Œå¹…']).cumprod()
p29['é£é™©é¢„ç®—_å‡€å€¼'] = (1+p29['é£é™©é¢„ç®—_æ¶¨è·Œå¹…']).cumprod()
p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'] = (1+p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_æ¶¨è·Œå¹…']).cumprod()
# å¯è§†åŒ–â€”â€”â€”â€”å›¾29:ç»„åˆå‡€å€¼
fig, ax1 = plt.subplots(figsize=(8,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
plt.plot(p29['å›ºå®šæ¯”ä¾‹_å‡€å€¼'], color='mediumblue',label='å›ºå®šæ¯”ä¾‹',lw=2.5) 
plt.plot(p29['é£é™©é¢„ç®—_å‡€å€¼'], color='royalblue',label='é£é™©é¢„ç®—',lw=2.5) 
plt.plot(p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'], color='gold',label='é£é™©é¢„ç®—ï¼ˆåŠ å…¥æˆ˜æœ¯æ‹©æ—¶ï¼‰',lw=2.5) 
plt.xlim([p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'].dropna().index[0],p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'].dropna().index[-1]]) 
plt.ylim([0.8,2.4])
plt.yticks([0.8,1,1.2,1.4,1.6,1.8,2,2.2,2.4])
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾29:ç»„åˆå‡€å€¼')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾29ï¼šç»„åˆå‡€å€¼.png',dpi=800)

#%%
# å¯è§†åŒ–â€”â€”â€”â€”å›¾30:ç»„åˆå›æ’¤
fig, ax1 = plt.subplots(figsize=(9,4))
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)
ax1.spines['bottom'].set_visible(False)
plt.plot(drawdown(p29['å›ºå®šæ¯”ä¾‹_å‡€å€¼'].dropna()),color='mediumblue',label='å›ºå®šæ¯”ä¾‹',lw=2.5)
plt.plot(drawdown(p29['é£é™©é¢„ç®—_å‡€å€¼'].dropna()),color='royalblue',label='é£é™©é¢„ç®—',lw=2.5)
plt.plot(drawdown(p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'].dropna()),color='gold',label='é£é™©é¢„ç®—ï¼ˆåŠ å…¥æˆ˜æœ¯æ‹©æ—¶ï¼‰',lw=2.5)
plt.axhline(y=0, color='black', linestyle='-', linewidth=1)
plt.xlim([p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'].dropna().index[0],p29['é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼'].dropna().index[-1]]) 
x = DateFormatter('%Y-%m-%d')
plt.gca().xaxis.set_major_formatter(x) # è®¾å®šxè½´datetimeæ˜¾ç¤ºæ ¼å¼
plt.xticks(rotation=30)
plt.xticks([dt.datetime(2012+j,12,31) for j in range(11)])
plt.title('å›¾30:ç»„åˆå›æ’¤')
plt.legend()
plt.tight_layout()
plt.savefig('./output/å›¾30ï¼šç»„åˆå›æ’¤.png',dpi=800)
#%%
# è¡¨23:å›ºå®šæ¯”ä¾‹->é£é™©é¢„ç®—->åŠ å…¥æ‹©æ—¶çš„é£é™©é¢„ç®—ç»„åˆå¹´åº¦ä¸šç»©
t23 =  pd.DataFrame()
t23_net = p29[['å›ºå®šæ¯”ä¾‹_å‡€å€¼','é£é™©é¢„ç®—_å‡€å€¼','é£é™©é¢„ç®—_æˆ˜æœ¯æ‹©æ—¶_å‡€å€¼']]
t23_net['year'] = t23_net.index.year
y_s = t23_net.index[-1].year - t23_net.index[0].year 
start_year = 2013
for  i in range(y_s):
    temp_1 = t23_net.loc[ t23_net['year'] ==  start_year,:]
    for j in t23_net.columns[:3]:
        # é£é™©é¢„ç®—è‚¡å€ºé‡‘97/2/1ä¸šç»©è¡¨ç°
        t23.loc[start_year,'æ”¶ç›Šç‡_'+j[:-3]] = Performance(temp_1[j]).annualized_returns
        t23.loc[start_year,'æ³¢åŠ¨ç‡_'+j[:-3]] = Performance(temp_1[j]).annualized_volatility
        t23.loc[start_year,'å¤æ™®_'+j[:-3]] = Performance(temp_1[j]).cal_sharp()
        t23.loc[start_year,'æœ€å¤§å›æ’¤_'+j[:-3]] = Performance(temp_1[j]).max_drawdown()
        t23.loc[start_year,'å¡ç›æ¯”ç‡_'+j[:-3]] = Performance(temp_1[j]).cal_calmar()    
    start_year += 1
for j in t23_net.columns[:3]:
    t23.loc['åŒºé—´','æ”¶ç›Šç‡_'+j[:-3]] = Performance(p29[j]).annualized_returns
    t23.loc['åŒºé—´','æ³¢åŠ¨ç‡_'+j[:-3]] = Performance(p29[j]).annualized_volatility
    t23.loc['åŒºé—´','å¤æ™®_'+j[:-3]] = Performance(p29[j]).cal_sharp()
    t23.loc['åŒºé—´','æœ€å¤§å›æ’¤_'+j[:-3]] = Performance(p29[j]).max_drawdown()
    t23.loc['åŒºé—´','å¡ç›æ¯”ç‡_'+j[:-3]] = Performance(p29[j]).cal_calmar()
t23.to_excel(r'./output/è¡¨23ï¼šå›ºå®šæ¯”ä¾‹->é£é™©é¢„ç®—->åŠ å…¥æ‹©æ—¶çš„é£é™©é¢„ç®—ç»„åˆå¹´åº¦ä¸šç»©.xlsx')










